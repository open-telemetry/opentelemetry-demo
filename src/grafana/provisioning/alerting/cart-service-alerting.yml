# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

---
apiVersion: 1
groups:
  - orgId: 1
    name: otel-demo
    folder: cart
    interval: 1m
    rules:
      - uid: des78nlna99tsf
        title: CartAddItemHighLatency
        condition: p95_threshold
        data:
          - refId: p95_duration
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: webstore-metrics
            model:
              editorMode: code
              expr: |-
                histogram_quantile(
                  0.95,
                  sum by (deployment_environment_name, "service.namespace", "service.name", "service.instance.id", "http.route", "http.request.method", le) (
                    rate(
                      {"http.server.request.duration_bucket",
                        deployment_environment_name="",
                        "service.namespace"="opentelemetry-demo",
                        "service.name"="cart",
                        "http.request.method"="POST",
                        "http.route"="/oteldemo.CartService/AddItem"
                      }[5m]
                    )
                  )
                )
              instant: true
              interval: ""
              intervalMs: 1000
              legendFormat: __auto
              maxDataPoints: 43200
              range: false
              refId: p95_duration
          - refId: p95_threshold
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.0001
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: p95_duration
              intervalMs: 1000
              maxDataPoints: 43200
              refId: p95_threshold
              type: threshold
        dashboardUid: febljk0a32qyoa
        panelId: 17
        noDataState: NoData
        execErrState: Error
        for: 1m
        keepFiringFor: 2m
        annotations:
          description: |-
            The 95th percentile response time for operation {{ index $labels "service.namespace"
                }}/{{ index $labels "service.name" }} "{{ index $labels "http.request.method" }} {{
                index $labels "http.route" }}" has been
                above 0.0001 seconds for 2 minutes on {{ index $labels "service.instance.id"}}. Current
                value: {{ .Value | humanizeDuration }}.
          summary: |-
            High P95 for {{ index $labels "service.namespace" }}/{{ index $labels "service.name" }} "{{
                index $labels "http.request.method" }} {{ index $labels "http.route" }}"
        labels:
          "service.name": cart
          "service.namespace": opentelemetry-demo
          severity: warning
          team_name: webstore
        isPaused: false
        notification_settings:
          receiver: grafana-default-email
