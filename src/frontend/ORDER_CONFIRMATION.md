# Order Confirmation Page Changes

This document describes the changes made to implement a dedicated order confirmation page and custom OpenTelemetry spans for order tracking.

## Overview

The order confirmation flow has been enhanced to:
1. Use a separate route for better RUM analytics and pageview tracking
2. Create custom OpenTelemetry spans (both backend and frontend) with order details
3. Enable order tracking and conversion analytics

## Changes Made

### 1. New Order Confirmation Route

**Previous Route:** `/cart/checkout/[orderId]`
**New Route:** `/order/confirmation/[orderId]`

**File Location:** `/pages/order/confirmation/[orderId]/index.tsx`

**Benefits:**
- Distinct pageview in RUM analytics separate from checkout flow
- Clear page title: "Order Confirmation" vs "Checkout"
- Better funnel tracking: Homepage → Product → Cart → Checkout → **Order Confirmation**
- Conversion tracking: Pageviews to `/order/confirmation/*` indicate successful purchases

### 2. Updated Redirect Logic

**File:** `components/Cart/CartDetail.tsx`
**Line:** 58

After a successful order placement, the application now redirects to:
```javascript
pathname: `/order/confirmation/${order.orderId}`
```

Instead of the previous:
```javascript
pathname: `/cart/checkout/${order.orderId}`
```

### 3. Backend OpenTelemetry Span

**File:** `pages/api/checkout.ts`
**Lines:** 36-56

When an order is successfully placed via the `/api/checkout` endpoint, a custom span is created:

**Span Name:** `order.confirmed`
**Tracer Name:** `frontend-api`

**Span Attributes:**
- `order.id` - The unique order identifier
- `order.items_count` - Number of unique items in the order
- `order.total_items` - Total quantity of all items (sum of quantities)
- `order.currency` - Currency code (e.g., USD, EUR)
- `order.user_id` - User who placed the order

**Example:**
```javascript
{
  'order.id': 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  'order.items_count': 3,
  'order.total_items': 5,
  'order.currency': 'USD',
  'order.user_id': 'user-12345'
}
```

**Console Output:**
```
Backend order confirmation span created: {
  orderId: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  itemsCount: 3,
  totalItems: 5
}
```

### 4. Frontend RUM Span

**File:** `pages/order/confirmation/[orderId]/index.tsx`
**Lines:** 23-47

When the order confirmation page loads in the browser, a custom RUM span is created:

**Span Name:** `order.confirmed`
**Tracer Name:** `appModuleLoader` (from global window.tracer)

**Span Attributes:**
- `order.id` - The unique order identifier
- `order.items_count` - Number of unique items in the order
- `order.total_items` - Total quantity of all items

**Example:**
```javascript
{
  'order.id': 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  'order.items_count': 3,
  'order.total_items': 5
}
```

**Console Output:**
```
Order confirmation span created: {
  orderId: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  itemsCount: 3,
  totalItems: 5
}
```

### 5. Global Tracer Exposure

**File:** `pages/_document.tsx`
**Line:** 97

The Splunk RUM tracer is now exposed globally on the window object:
```javascript
window.tracer = tracer; // Make tracer available globally for custom spans
```

**File:** `pages/_app.tsx`
**Line:** 29

TypeScript type declaration added:
```typescript
tracer?: any; // OpenTelemetry tracer for custom spans
```

## APM and Analytics Usage

### Backend Traces

In your APM, you'll see backend traces with the following structure:

```
POST /api/checkout
├─ order.confirmed (custom span)
├─ CheckoutGateway.placeOrder
│  └─ gRPC call to checkout service
└─ ProductCatalogService.getProduct (for each item)
   └─ gRPC call to product catalog service
```

### RUM Traces

In Splunk RUM, you'll see:
- Pageview for `/order/confirmation/[orderId]`
- Custom `order.confirmed` span with order details
- Session replay (if enabled) showing the confirmation screen

### Query Examples

**Find all orders by a specific user:**
```
span.name="order.confirmed" AND order.user_id="user-12345"
```

**Track orders over $100 (requires additional attributes):**
```
span.name="order.confirmed" AND order.total_items>10
```

**Count successful orders by currency:**
```
span.name="order.confirmed" | stats count by order.currency
```

**Track conversion rate:**
```
(pageviews to /order/confirmation/*) / (pageviews to /cart/checkout)
```

## Order ID Structure

Order IDs are generated by the backend checkout service and follow the UUID v4 format:

**Format:** `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`

**Example:** `a1b2c3d4-e5f6-7890-abcd-ef1234567890`

**Properties:**
- Unique per order
- Generated server-side by the checkout service
- Returned in the `OrderResult` protobuf message
- Stored in browser query parameters during redirect
- Logged in both backend and frontend spans

## Testing

### Verify Backend Span

1. Place an order through the application
2. Check the backend logs for:
   ```
   Backend order confirmation span created: { orderId: '...', itemsCount: X, totalItems: Y }
   ```
3. Search APM for `span.name="order.confirmed"` with your order ID

### Verify Frontend RUM Span

1. Complete the checkout process
2. Land on the order confirmation page
3. Open browser console and look for:
   ```
   Order confirmation span created: { orderId: '...', itemsCount: X, totalItems: Y }
   ```
4. Check Splunk RUM for the `order.confirmed` span

### Verify Page Route

1. Complete checkout
2. Verify the URL is `/order/confirmation/[orderId]` (not `/cart/checkout/[orderId]`)
3. Verify the page title is "Otel Demo - Order Confirmation"
4. Check RUM pageviews for the new route

## Troubleshooting

### Backend Span Not Appearing

**Issue:** No `order.confirmed` span in backend traces

**Checks:**
- Verify OpenTelemetry instrumentation is loaded (check for initialization log)
- Set `OTEL_LOG_LEVEL=DEBUG` to see span creation
- Verify `@opentelemetry/api` package is installed
- Check that the order placement succeeds (no errors in `/api/checkout`)

### Frontend RUM Span Not Appearing

**Issue:** No `order.confirmed` span in RUM

**Checks:**
- Verify Splunk RUM is initialized (check browser console)
- Verify `window.tracer` is defined (type `window.tracer` in console)
- Check browser console for "Order confirmation span created" log
- Verify order data is passed in query parameters

### Wrong Route

**Issue:** Still redirecting to `/cart/checkout/[orderId]`

**Checks:**
- Verify `CartDetail.tsx` has been updated with the new route
- Clear browser cache and reload
- Check the image version deployed (should be 2.1.3-RUM or later)

## Migration Notes

### Backward Compatibility

The old route `/cart/checkout/[orderId]` still exists and works for backward compatibility. However, new orders will use the new `/order/confirmation/[orderId]` route.

### Data Migration

No data migration is required. The change only affects:
- The route used for order confirmation display
- Addition of custom spans for analytics

Existing orders and historical data are not affected.

## Related Documentation

- [GLOBAL_ATTRIBUTES.MD](./GLOBAL_ATTRIBUTES.MD) - RUM global attributes documentation
- [Splunk RUM Documentation](https://docs.splunk.com/Observability/rum/intro-to-rum.html)
- [OpenTelemetry Tracing](https://opentelemetry.io/docs/instrumentation/js/instrumentation/)

## Version History

- **v2.1.3-RUM** - Initial implementation
  - New order confirmation route
  - Backend and frontend custom spans
  - Order ID tracking in spans
