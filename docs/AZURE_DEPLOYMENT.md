# Azure Data Explorer Deployment Guide

This guide walks you through deploying the OpenTelemetry Demo with Azure Data Explorer (ADX) as the telemetry backend.

## Architecture Overview

```
                                    Azure Cloud
    +------------------------------------------------------------------+
    |                                                                  |
    |   +------------------+         +-------------------+             |
    |   |                  |         |                   |             |
    |   |  Azure Data      |<--------|  OpenTelemetry    |             |
    |   |  Explorer (ADX)  |         |  Collector        |             |
    |   |                  |         |                   |             |
    |   +------------------+         +--------^----------+             |
    |          |                              |                        |
    |          |                     +--------+----------+             |
    |          v                     |                   |             |
    |   +------------------+         |   Microservices   |             |
    |   |                  |         |   (17 services)   |             |
    |   |     Grafana      |         |                   |             |
    |   |   (Dashboards)   |         +-------------------+             |
    |   |                  |                                           |
    |   +------------------+         Azure Kubernetes Service          |
    |                                                                  |
    +------------------------------------------------------------------+
```

## Prerequisites

- Azure subscription with Owner or Contributor access
- Azure CLI installed and configured
- Terraform >= 1.5.0
- kubectl
- Helm (optional)

## Quick Start

### 1. Clone the Repository

```bash
git clone https://github.com/YOUR_ORG/adx-opentelemetry-demo.git
cd adx-opentelemetry-demo
```

### 2. Deploy Azure Infrastructure with Terraform

```bash
cd terraform

# Copy and configure variables
cp terraform.tfvars.example terraform.tfvars

# Edit terraform.tfvars with your preferences
# - project_name: Prefix for all resources
# - location: Azure region (e.g., eastus, westeurope)
# - environment: dev, staging, or prod

# Initialize Terraform
terraform init

# Review the plan
terraform plan

# Deploy infrastructure
terraform apply
```

This creates:
- Azure Data Explorer cluster with database and tables
- Azure Kubernetes Service cluster
- Service Principal for ADX authentication
- Virtual Network and subnet

### 3. Deploy to AKS

```bash
# Return to project root
cd ..

# Run the deployment script
./scripts/deploy-to-aks.sh
```

Or manually:

```bash
# Get AKS credentials
az aks get-credentials --resource-group otel-demo-dev-rg --name otel-demo-dev-aks

# Create namespace
kubectl create namespace otel-demo

# Apply secrets (generated by Terraform)
kubectl apply -f kubernetes/azure/secrets.yaml

# Apply OTel Collector ConfigMap
kubectl apply -f kubernetes/azure/otel-collector-configmap.yaml

# Deploy the demo (use base manifest for now)
kubectl apply -f kubernetes/opentelemetry-demo.yaml
```

### 4. Access the Demo

```bash
# Frontend (Web UI)
kubectl port-forward -n otel-demo svc/frontend-proxy 8080:8080
# Open: http://localhost:8080

# Grafana (Dashboards)
kubectl port-forward -n otel-demo svc/grafana 3000:3000
# Open: http://localhost:3000

# Load Generator
kubectl port-forward -n otel-demo svc/load-generator 8089:8089
# Open: http://localhost:8089
```

## Manual Setup (Without Terraform)

If you prefer not to use Terraform:

### 1. Create ADX Cluster

```bash
# Create resource group
az group create --name otel-demo-rg --location eastus

# Create ADX cluster
az kusto cluster create \
  --name oteladx \
  --resource-group otel-demo-rg \
  --location eastus \
  --sku name="Dev(No SLA)_Standard_D11_v2" capacity=1

# Create database
az kusto database create \
  --cluster-name oteladx \
  --resource-group otel-demo-rg \
  --database-name otel_demo \
  --soft-delete-period P365D \
  --hot-cache-period P30D
```

### 2. Create Tables and Mappings

Open ADX Web UI and run the schema script:

```bash
# Get cluster URI
az kusto cluster show --name oteladx --resource-group otel-demo-rg --query uri -o tsv
```

Navigate to the URI, select the database, and run `adx/schema.kql`.

### 3. Create Service Principal

```bash
# Create service principal
az ad sp create-for-rbac --name "otel-demo-sp" --skip-assignment

# Note the output:
# - appId (AZURE_CLIENT_ID)
# - password (AZURE_CLIENT_SECRET)
# - tenant (AZURE_TENANT_ID)

# Grant ADX permissions
az kusto database-principal-assignment create \
  --cluster-name oteladx \
  --resource-group otel-demo-rg \
  --database-name otel_demo \
  --principal-assignment-name sp-ingestor \
  --principal-id <appId> \
  --principal-type App \
  --role Ingestor

az kusto database-principal-assignment create \
  --cluster-name oteladx \
  --resource-group otel-demo-rg \
  --database-name otel_demo \
  --principal-assignment-name sp-viewer \
  --principal-id <appId> \
  --principal-type App \
  --role Viewer
```

### 4. Create AKS Cluster

```bash
az aks create \
  --resource-group otel-demo-rg \
  --name otel-demo-aks \
  --node-count 3 \
  --node-vm-size Standard_DS2_v2 \
  --generate-ssh-keys
```

### 5. Configure Secrets

```bash
# Copy template
cp kubernetes/azure/secrets-template.yaml kubernetes/azure/secrets.yaml

# Edit with your values
# - AZURE_TENANT_ID
# - AZURE_CLIENT_ID
# - AZURE_CLIENT_SECRET
# - ADX_CLUSTER_URI
# - ADX_DATABASE
```

## Configuration Reference

### Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `AZURE_TENANT_ID` | Azure AD tenant ID | `12345678-1234-1234-1234-123456789012` |
| `AZURE_CLIENT_ID` | Service Principal app ID | `87654321-4321-4321-4321-210987654321` |
| `AZURE_CLIENT_SECRET` | Service Principal secret | `your-secret-here` |
| `ADX_CLUSTER_URI` | ADX cluster endpoint | `https://oteladx.eastus.kusto.windows.net` |
| `ADX_DATABASE` | ADX database name | `otel_demo` |

### Terraform Variables

See `terraform/terraform.tfvars.example` for all available options:

| Variable | Default | Description |
|----------|---------|-------------|
| `project_name` | `otel-demo` | Resource name prefix |
| `location` | `eastus` | Azure region |
| `adx_sku_name` | `Dev(No SLA)_Standard_D11_v2` | ADX SKU |
| `adx_retention_days` | `365` | Data retention |
| `aks_default_node_pool_count` | `3` | AKS node count |

## Grafana Dashboards

The deployment includes pre-configured dashboards:

1. **OpenTelemetry APM - Azure Data Explorer** (`adx-apm-dashboard`)
   - Service overview stats
   - Request rate by service
   - P95 latency trends
   - Error rate analysis
   - Service performance table

### Adding Custom Dashboards

1. Create a JSON dashboard file
2. Add to `src/grafana/provisioning/dashboards/demo/`
3. Use `adx-telemetry` as the datasource UID
4. Write KQL queries in raw mode

Example panel query:
```kql
OTelTraces
| where Timestamp > ago(1h)
| summarize Count = count() by ServiceName, bin(Timestamp, 1m)
```

## Troubleshooting

### Pods Not Starting

```bash
# Check pod status
kubectl get pods -n otel-demo

# Check pod logs
kubectl logs -n otel-demo -l app.kubernetes.io/component=collector

# Describe pod for events
kubectl describe pod -n otel-demo <pod-name>
```

### ADX Connection Issues

```bash
# Verify secrets are correct
kubectl get secret -n otel-demo adx-credentials -o yaml

# Test ADX connectivity from collector
kubectl exec -n otel-demo -it <collector-pod> -- wget -qO- https://your-cluster.kusto.windows.net
```

### No Data in Grafana

1. Verify collector is running and sending data
2. Check ADX tables have data:
   ```kql
   OTelTraces | count
   OTelMetrics | count
   OTelLogs | count
   ```
3. Verify Grafana datasource configuration
4. Check Grafana logs for connection errors

## Cost Estimation

| Resource | SKU | Estimated Monthly Cost |
|----------|-----|----------------------|
| ADX Cluster | Dev(No SLA)_Standard_D11_v2 | ~$150/month |
| AKS Cluster | 3x Standard_DS2_v2 | ~$300/month |
| Storage | Varies by data volume | ~$20-50/month |

**Tips to reduce costs:**
- Use ADX auto-stop for dev environments
- Scale down AKS nodes when not in use
- Adjust hot cache period based on query patterns

## Security Best Practices

1. **Rotate Service Principal secrets** every 180 days (automated via Terraform)
2. **Use private endpoints** for production deployments
3. **Enable Azure Monitor** for infrastructure monitoring
4. **Configure network policies** to restrict pod communication
5. **Use Azure Key Vault** for secret management in production

## Next Steps

- **[Integrate Your Own Services](INTEGRATE_YOUR_SERVICES.md)** - Step-by-step guide to instrument your applications
- Explore [KQL queries](../adx/example-queries.kql) for common observability patterns
- Customize dashboards for your use cases
- Set up alerts in Grafana
- Configure Azure Monitor integration

## Support

For issues specific to this ADX integration:
- Open an issue in this repository

For general OpenTelemetry Demo questions:
- See [OpenTelemetry Demo documentation](https://opentelemetry.io/docs/demo/)
