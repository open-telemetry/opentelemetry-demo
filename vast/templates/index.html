<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observability Diagnostic Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: rgba(26, 26, 36, 0.8);
            --border-color: rgba(255, 255, 255, 0.06);
            --border-glow: rgba(0, 217, 255, 0.2);
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent-primary: #00d9ff;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --gradient-primary: linear-gradient(135deg, #00d9ff 0%, #7c3aed 100%);
            --gradient-bg: linear-gradient(180deg, #0a0a0f 0%, #12121a 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 30px rgba(0, 217, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            padding: 24px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-glow);
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-section {
            margin-bottom: 28px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-muted);
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--accent-primary);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        .status-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .status-card-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin: -2px -8px;
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .service-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .service-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .status-healthy {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .status-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .status-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Alerts Styling */
        .alerts-badge {
            background: var(--accent-error);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .alerts-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-item:hover {
            transform: translateX(2px);
        }

        .alert-critical {
            background: rgba(239, 68, 68, 0.12);
            border-left: 3px solid var(--accent-error);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.12);
            border-left: 3px solid var(--accent-warning);
        }

        .alert-info {
            background: rgba(0, 217, 255, 0.12);
            border-left: 3px solid var(--accent-primary);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .alert-severity {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .alert-severity.critical { color: var(--accent-error); }
        .alert-severity.warning { color: var(--accent-warning); }
        .alert-severity.info { color: var(--accent-primary); }

        .alert-category {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            margin-left: 6px;
        }

        .alert-category.root-cause {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .alert-category.symptom {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .alert-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .alert-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .alert-description {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .alert-root-cause {
            font-size: 11px;
            color: var(--accent-primary);
            line-height: 1.4;
            font-weight: 500;
        }

        .alert-summary {
            display: flex;
            gap: 12px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .alert-summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .alert-summary-count {
            font-weight: 600;
        }

        .alert-summary-count.critical { color: var(--accent-error); }
        .alert-summary-count.warning { color: var(--accent-warning); }

        /* Activity log styles */
        .activity-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .activity-event {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            font-size: 11px;
        }

        .activity-icon {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .activity-icon.created {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-error);
        }

        .activity-icon.auto_resolved {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-success);
        }

        .activity-icon.resolved {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-primary);
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-text {
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .activity-text strong {
            color: var(--text-primary);
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 10px;
            margin-top: 2px;
        }

        .error-item {
            padding: 12px;
            background: rgba(239, 68, 68, 0.08);
            border-left: 3px solid var(--accent-error);
            margin-bottom: 8px;
            border-radius: 0 10px 10px 0;
            transition: all 0.2s;
        }

        .error-item:hover {
            background: rgba(239, 68, 68, 0.12);
        }

        .error-service {
            color: var(--accent-error);
            font-weight: 600;
            font-size: 12px;
        }
        .error-span {
            color: var(--text-muted);
            font-size: 11px;
            margin-top: 2px;
        }

        .last-updated {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-primary);
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 16px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .header-actions button:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 28px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            max-width: 80%;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            margin-left: auto;
            align-self: flex-end;
        }

        .message-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message.user .message-label { text-align: right; }

        .message-content {
            padding: 18px 22px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 14px;
        }

        .message.user .message-content {
            background: var(--gradient-primary);
            color: #fff;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
        }

        /* Charts */
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            max-width: 650px;
        }

        .chart-container canvas {
            max-height: 280px;
        }

        /* Query Results */
        .query-block {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin: 12px 0;
            overflow: hidden;
        }

        .query-header {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-primary);
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .query-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .query-sql {
            padding: 16px;
            background: var(--bg-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            white-space: pre-wrap;
            overflow-x: auto;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .query-results { padding: 16px; }

        .query-results table {
            width: 100%;
            border-collapse: collapse;
        }

        .query-results th {
            background: var(--bg-tertiary);
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .query-results td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .query-results tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Input Area */
        .input-area {
            padding: 16px 28px 28px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .input-options {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .time-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-selector label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .time-selector select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .time-selector select:hover {
            border-color: var(--accent-primary);
        }

        .time-selector select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 8px;
            transition: all 0.3s;
        }

        .input-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        .input-container textarea {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            height: 48px;
            font-family: inherit;
            line-height: 1.5;
        }

        .input-container textarea::placeholder {
            color: var(--text-muted);
        }

        .input-container textarea:focus { outline: none; }

        .input-container button {
            background: var(--gradient-primary);
            border: none;
            color: #fff;
            padding: 0 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-container button:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-glow);
        }

        .input-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Markdown styling */
        .message-content h1, .message-content h2, .message-content h3 {
            color: var(--accent-primary);
            margin: 18px 0 10px 0;
        }
        .message-content h2 { font-size: 16px; }
        .message-content h3 { font-size: 14px; }
        .message-content ul, .message-content ol { margin: 12px 0; padding-left: 24px; }
        .message-content li { margin: 6px 0; }
        .message-content .prompt-hints { list-style: none; padding-left: 0; }
        .message-content .prompt-hints li {
            cursor: pointer;
            padding: 8px 12px;
            margin: 4px 0;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            color: var(--accent-primary);
        }
        .message-content .prompt-hints li:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }
        .message-content code {
            background: var(--bg-primary);
            padding: 3px 8px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent-primary);
        }
        .message-content pre {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--border-color);
        }
        .message-content pre code { background: none; padding: 0; color: var(--text-secondary); }
        .message-content strong { color: var(--accent-primary); font-weight: 600; }

        /* Compact diagnostic output styling */
        .message-content h2, .message-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content h2:first-child, .message-content h3:first-child {
            margin-top: 0;
        }

        .message-content ol, .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content ol ol, .message-content ol ul,
        .message-content ul ol, .message-content ul ul {
            margin: 4px 0;
        }

        .message-content li {
            margin: 2px 0;
            line-height: 1.4;
        }

        .message-content ol {
            list-style-type: decimal;
        }

        .message-content li > strong:first-child {
            color: var(--text-primary);
        }

        .message-content p {
            margin: 6px 0;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        /* Key findings, recommendations styling */
        .message-content li code {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        /* Agent questions - stand out from informational content */
        .message-content .agent-question {
            background: rgba(0, 217, 255, 0.08);
            border-left: 3px solid var(--accent-primary);
            padding: 10px 14px;
            margin: 12px 0 4px 0;
            border-radius: 0 8px 8px 0;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 950px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--accent-error);
            color: var(--accent-error);
        }

        .modal-body { padding: 24px; }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s;
        }

        .chart-card:hover {
            border-color: var(--border-glow);
        }

        .chart-card h4 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ops-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ops-table th, .ops-table td {
            padding: 12px;
            text-align: left;
            font-size: 12px;
        }

        .ops-table th {
            color: var(--accent-primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        .ops-table td {
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .ops-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .chart-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 900px) {
            .sidebar { display: none; }
        }

        /* Empty state */
        .empty-state {
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            padding: 16px;
        }

        /* Auto-refresh controls */
        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
        }

        .toggle-switch.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(16px);
            background: white;
        }

        .modal-refresh-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .modal-refresh-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-refresh-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .modal-refresh-btn.spinning svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .auto-refresh-indicator {
            font-size: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .auto-refresh-indicator.active {
            color: var(--accent-success);
        }

        .auto-refresh-indicator .dot {
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
        }

        .auto-refresh-indicator.active .dot {
            background: var(--accent-success);
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Service selector dropdown */
        .modal-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            min-width: 180px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a0a0b0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
            transition: all 0.2s;
        }

        .service-selector:hover {
            border-color: var(--accent-primary);
        }

        .service-selector:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        .service-selector option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
        }

        .modal-type-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-type-badge.service {
            background: rgba(0, 217, 255, 0.15);
            color: var(--accent-primary);
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .modal-type-badge.database {
            background: rgba(124, 58, 237, 0.15);
            color: var(--accent-secondary);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        /* Time window selector */
        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-card-header h4 {
            margin-bottom: 0;
        }

        .time-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            padding: 4px 8px;
            font-size: 10px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23a0a0b0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            padding-right: 22px;
            transition: all 0.2s;
        }

        .time-selector:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .time-selector:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .time-selector option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Error modal styling */
        .modal-type-badge.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .error-detail-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .error-detail-card h4 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .error-detail-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .error-detail-label {
            color: var(--text-muted);
            width: 120px;
            flex-shrink: 0;
        }

        .error-detail-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
        }

        .error-detail-value.error-text {
            color: var(--accent-error);
        }

        .trace-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .trace-table th {
            background: var(--bg-tertiary);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }

        .trace-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .trace-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .trace-table tr.error-row td {
            background: rgba(239, 68, 68, 0.08);
        }

        .trace-depth {
            color: var(--text-muted);
            font-size: 10px;
        }

        /* Error summary card */
        .error-summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .error-summary-card:hover {
            border-color: var(--border-glow);
        }

        .error-summary-card.has-errors {
            border-left: 3px solid var(--accent-error);
        }

        .error-summary-card.no-errors {
            border-left: 3px solid var(--accent-success);
        }

        .error-summary-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-count {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-error);
        }

        .error-count.zero {
            color: var(--accent-success);
        }

        .error-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .error-services {
            text-align: right;
        }

        .error-services-count {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .expand-hint {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }

        .errors-list-collapsed {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .errors-list-expanded {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 8px;
        }

        /* Progress indicator for chat */
        .progress-container {
            margin-top: 12px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .progress-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .progress-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .progress-step {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-message {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .progress-detail {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 6px;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-steps {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .progress-step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s;
        }

        .progress-step-dot.active {
            background: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-primary);
        }

        .progress-step-dot.completed {
            background: var(--accent-success);
        }

        .query-progress-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding: 6px 8px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .query-progress-item .check {
            color: var(--accent-success);
            font-weight: bold;
        }

        .query-progress-item .rows {
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Host metrics styling */
        .host-item {
            padding: 10px 12px;
            margin: -2px -8px;
            border-radius: 10px;
        }

        .host-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .host-metrics {
            display: flex;
            gap: 8px;
        }

        .host-metric {
            flex: 1;
            text-align: center;
            padding: 6px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .host-metric-value {
            font-size: 14px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .host-metric-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-ok { color: var(--accent-success); }
        .metric-warn { color: var(--accent-warning); }
        .metric-error { color: var(--accent-error); }

        .host-item:hover {
            background: var(--bg-secondary);
            transition: background 0.2s ease;
        }

        /* Host modal styling */
        .host-detail-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .host-metric-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .host-metric-card .value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .host-metric-card .label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 8px;
        }

        .host-info {
            display: grid;
            gap: 12px;
        }

        .host-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .host-info-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        .host-info-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        /* Topology graph styling */
        .topology-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            max-width: 800px;
        }

        .topology-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .topology-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
        }

        .topology-graph {
            height: 400px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .topology-legend {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.service { background: #00d9ff; }
        .legend-dot.database { background: #7c3aed; }
        .legend-dot.external { background: #f59e0b; }
        .legend-dot.error { background: #ef4444; }

        /* Modal tabs */
        .modal-tabs {
            display: flex;
            gap: 4px;
            padding: 0 24px 16px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .modal-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .modal-tab.active {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
            border-bottom-color: var(--bg-primary);
            color: var(--accent-primary);
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .tab-badge {
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .modal-tab.active .tab-badge {
            background: rgba(0, 217, 255, 0.15);
            color: var(--accent-primary);
        }

        /* Data tables for logs/traces/metrics */
        .data-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: var(--bg-tertiary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tr.error-row td {
            background: rgba(239, 68, 68, 0.08);
        }

        .data-table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }

        .severity-debug { color: var(--text-muted); }
        .severity-info { color: var(--accent-primary); }
        .severity-warn { color: var(--accent-warning); }
        .severity-error { color: var(--accent-error); }

        .log-body {
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .log-body:hover {
            white-space: normal;
            word-break: break-all;
        }

        .tab-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .tab-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Dependencies list */
        .deps-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dep-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dep-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .dep-item:last-child {
            border-bottom: none;
        }

        .dep-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .dep-type-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .dep-type-badge.service {
            background: rgba(0, 217, 255, 0.15);
            color: var(--accent-primary);
        }

        .dep-type-badge.database {
            background: rgba(124, 58, 237, 0.15);
            color: var(--accent-secondary);
        }

        .dep-calls {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Help Modal Styles */
        .help-modal {
            max-width: 900px;
        }

        .help-body {
            padding: 24px;
        }

        .architecture-diagram {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .arch-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .arch-row:last-child {
            margin-bottom: 0;
        }

        .arch-component {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .arch-component:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
        }

        .arch-component.apps { border-left: 3px solid #10b981; }
        .arch-component.collector { border-left: 3px solid #f59e0b; }
        .arch-component.kafka { border-left: 3px solid #ef4444; }
        .arch-component.ingester { border-left: 3px solid #8b5cf6; }
        .arch-component.database { border-left: 3px solid #06b6d4; }
        .arch-component.trino { border-left: 3px solid #ec4899; }
        .arch-component.ui { border-left: 3px solid #00d9ff; }

        .arch-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .arch-label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .arch-desc {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .arch-arrow {
            font-size: 24px;
            color: var(--accent-primary);
            font-weight: bold;
        }

        .help-section {
            margin-bottom: 24px;
        }

        .help-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-flow-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .flow-card {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border-color);
        }

        .flow-card.traces { border-left: 3px solid #7c3aed; }
        .flow-card.metrics { border-left: 3px solid #10b981; }
        .flow-card.logs { border-left: 3px solid #f59e0b; }

        .flow-icon {
            font-size: 24px;
        }

        .flow-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }

        .flow-path {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .how-it-works {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 16px 16px 16px 32px;
            margin: 0;
        }

        .how-it-works li {
            margin: 8px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .how-it-works li strong {
            color: var(--accent-primary);
        }

        .diagnostic-steps {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .diag-step {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-num {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            flex-shrink: 0;
        }

        .step-text {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .data-flow-cards,
            .diagnostic-steps {
                grid-template-columns: 1fr;
            }
            .arch-row {
                flex-direction: column;
            }
            .arch-arrow {
                transform: rotate(90deg);
            }
        }

        /* Alert Detail Modal */
        .alert-modal {
            max-width: 700px;
        }

        .alert-detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .alert-detail-severity {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .alert-detail-severity.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-error);
        }

        .alert-detail-severity.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .alert-detail-severity.info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-primary);
        }

        .alert-detail-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .alert-detail-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .alert-meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .alert-meta-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .alert-meta-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .alert-section {
            margin-bottom: 20px;
        }

        .alert-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-section-content {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .alert-section-content.root-cause {
            border-left: 3px solid var(--accent-error);
            color: var(--text-primary);
            font-weight: 500;
        }

        .alert-section-content.actions {
            border-left: 3px solid var(--accent-success);
        }

        .alert-section-content.evidence {
            border-left: 3px solid var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .alert-no-investigation {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .alert-no-investigation-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .alert-no-investigation-text {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .alert-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .alert-action-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .alert-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .alert-action-btn.primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .alert-action-btn.secondary {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .alert-action-btn.secondary:hover {
            background: var(--bg-tertiary);
        }

        .alert-action-btn.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .alert-action-btn.warning:hover {
            background: rgba(245, 158, 11, 0.25);
        }

        .alert-investigation-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .alert-investigation-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">O</div>
            <span class="logo-text">Observability</span>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Recent Errors</span>
                <div class="refresh-controls">
                    <div class="toggle-container">
                        <span class="toggle-label">Auto</span>
                        <div class="toggle-switch active" id="sidebar-auto-toggle" onclick="toggleSidebarAutoRefresh()"></div>
                    </div>
                    <button class="refresh-btn" onclick="refreshStatus()">Refresh</button>
                </div>
            </div>
            <div id="error-summary" class="error-summary-card">
                <div class="empty-state">Loading...</div>
            </div>
            <div id="errors-list" class="errors-list-collapsed"></div>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Predictive Alerts</span>
                <span id="alerts-badge" class="alerts-badge" style="display: none;">0</span>
            </div>
            <div id="alerts-list" class="alerts-list">
                <div class="empty-state">Loading...</div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Alert Activity</span>
            </div>
            <div id="activity-list" class="activity-list">
                <div class="empty-state">Loading...</div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Services</span>
                <select class="time-selector" id="services-time-selector" onchange="refreshStatus()">
                    <option value="1m">1m</option>
                    <option value="5m" selected>5m</option>
                    <option value="15m">15m</option>
                    <option value="1h">1h</option>
                </select>
            </div>
            <div class="status-card">
                <div class="status-card-title">Click to drill down</div>
                <div id="services-list"><div class="empty-state">Loading...</div></div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Databases</span>
            </div>
            <div class="status-card">
                <div class="status-card-title">Click to drill down</div>
                <div id="databases-list"><div class="empty-state">Loading...</div></div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Hosts</span>
            </div>
            <div class="status-card">
                <div class="status-card-title">System resources</div>
                <div id="hosts-list"><div class="empty-state">Loading...</div></div>
            </div>
        </div>

        <div class="last-updated">Last updated: <span id="last-updated">-</span></div>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1>Diagnostic Chat</h1>
            <div class="header-actions">
                <button onclick="openHelpModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Help
                </button>
                <button onclick="clearChat()">Clear Chat</button>
            </div>
        </header>

        <div class="chat-container" id="chat-container">
            <div class="message assistant">
                <div class="message-label">Assistant</div>
                <div class="message-content">
                    <p>Hello! I'm your observability diagnostic assistant. I can help you investigate issues by querying logs, metrics, and traces.</p>
                    <p><strong>Example questions:</strong></p>
                    <ul class="prompt-hints">
                        <li onclick="setPrompt(&quot;The frontend is slow, what's wrong?&quot;)">The frontend is slow, what's wrong?</li>
                        <li onclick="setPrompt('Show me errors in the last 5 minutes')">Show me errors in the last 5 minutes</li>
                        <li onclick="setPrompt('Show me a graph of latency for checkout service')">Show me a graph of latency for checkout service</li>
                        <li onclick="setPrompt('Chart error rates by service over the last hour')">Chart error rates by service over the last hour</li>
                        <li onclick="setPrompt('Show me the topology for PostgreSQL - what depends on it?')">Show me the topology for PostgreSQL - what depends on it?</li>
                        <li onclick="setPrompt('What does the frontend depend on?')">What does the frontend depend on? (show upstream deps)</li>
                    </ul>
                    <p>What would you like to investigate?</p>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <textarea id="message-input" placeholder="Describe the issue or ask for a visualization..." onkeydown="handleKeyDown(event)"></textarea>
                <button id="send-btn" onclick="sendMessage()">
                    <span>Send</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Service Drill-down Modal -->
    <div class="modal-overlay" id="service-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <span class="modal-type-badge service">Service</span>
                    <select class="service-selector" id="service-selector" onchange="switchService(this.value)">
                        <option value="">Loading services...</option>
                    </select>
                </div>
                <div class="modal-refresh-controls">
                    <div class="auto-refresh-indicator" id="modal-auto-indicator">
                        <span class="dot"></span>
                        <span>Auto-refresh off</span>
                    </div>
                    <div class="toggle-container">
                        <span class="toggle-label">Auto</span>
                        <div class="toggle-switch" id="modal-auto-toggle" onclick="toggleModalAutoRefresh()"></div>
                    </div>
                    <button class="modal-refresh-btn" id="modal-refresh-btn" onclick="refreshServiceModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
            </div>
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchModalTab('charts')">Charts</div>
                <div class="modal-tab" onclick="switchModalTab('deps')">Dependencies</div>
                <div class="modal-tab" onclick="switchModalTab('traces')">Traces <span class="tab-badge" id="traces-count">-</span></div>
                <div class="modal-tab" onclick="switchModalTab('logs')">Logs <span class="tab-badge" id="logs-count">-</span></div>
                <div class="modal-tab" onclick="switchModalTab('metrics')">Metrics <span class="tab-badge" id="metrics-count">-</span></div>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Charts Tab -->
                <div class="modal-tab-content active" id="tab-charts">
                    <div class="chart-row">
                        <div class="chart-card">
                            <h4>Latency Over Time</h4>
                            <canvas id="latency-chart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>Error Rate Over Time</h4>
                            <canvas id="error-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-card">
                            <h4>Request Volume</h4>
                            <canvas id="throughput-chart"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h4>Top Operations</h4>
                                <select class="time-selector" id="ops-time-selector" onchange="refreshTopOperations()">
                                    <option value="10s">Last 10s</option>
                                    <option value="30s">Last 30s</option>
                                    <option value="1m">Last 1m</option>
                                    <option value="5m" selected>Last 5m</option>
                                    <option value="15m">Last 15m</option>
                                    <option value="1h">Last 1h</option>
                                </select>
                            </div>
                            <table class="ops-table" id="ops-table">
                                <thead><tr><th>Operation</th><th>Calls</th><th>Avg Latency</th><th>Error %</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Traces Tab -->
                <div class="modal-tab-content" id="tab-traces">
                    <div class="tab-controls">
                        <span class="tab-title">Recent Traces</span>
                        <select class="time-selector" id="traces-time-selector" onchange="loadServiceTraces()">
                            <option value="1m">Last 1m</option>
                            <option value="5m" selected>Last 5m</option>
                            <option value="15m">Last 15m</option>
                            <option value="1h">Last 1h</option>
                        </select>
                    </div>
                    <div class="data-table-container">
                        <div class="data-table-wrapper">
                            <table class="data-table" id="traces-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Operation</th>
                                        <th>Kind</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Trace ID</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div class="modal-tab-content" id="tab-logs">
                    <div class="tab-controls">
                        <span class="tab-title">Recent Logs</span>
                        <select class="time-selector" id="logs-time-selector" onchange="loadServiceLogs()">
                            <option value="1m">Last 1m</option>
                            <option value="5m" selected>Last 5m</option>
                            <option value="15m">Last 15m</option>
                            <option value="1h">Last 1h</option>
                        </select>
                    </div>
                    <div class="data-table-container">
                        <div class="data-table-wrapper">
                            <table class="data-table" id="logs-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Severity</th>
                                        <th>Message</th>
                                        <th>Trace ID</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Metrics Tab -->
                <div class="modal-tab-content" id="tab-metrics">
                    <div class="tab-controls">
                        <span class="tab-title">Service Metrics</span>
                        <select class="time-selector" id="metrics-time-selector" onchange="loadServiceMetrics()">
                            <option value="1m">Last 1m</option>
                            <option value="5m" selected>Last 5m</option>
                            <option value="15m">Last 15m</option>
                            <option value="1h">Last 1h</option>
                        </select>
                    </div>
                    <div class="data-table-container">
                        <div class="data-table-wrapper">
                            <table class="data-table" id="metrics-table">
                                <thead>
                                    <tr>
                                        <th>Metric Name</th>
                                        <th>Data Points</th>
                                        <th>Avg Value</th>
                                        <th>Min</th>
                                        <th>Max</th>
                                        <th>Last Seen</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Dependencies Tab -->
                <div class="modal-tab-content" id="tab-deps">
                    <div class="chart-row">
                        <div class="chart-card">
                            <h4>Upstream (What Calls This Service)</h4>
                            <div class="deps-list" id="upstream-deps">
                                <div class="empty-state">Loading...</div>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Downstream (What This Service Calls)</h4>
                            <div class="deps-list" id="downstream-deps">
                                <div class="empty-state">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Drill-down Modal -->
    <div class="modal-overlay" id="database-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <span class="modal-type-badge database">Database</span>
                    <select class="service-selector" id="database-selector" onchange="switchDatabase(this.value)">
                        <option value="">Loading databases...</option>
                    </select>
                </div>
                <div class="modal-refresh-controls">
                    <div class="auto-refresh-indicator" id="db-modal-auto-indicator">
                        <span class="dot"></span>
                        <span>Auto-refresh off</span>
                    </div>
                    <div class="toggle-container">
                        <span class="toggle-label">Auto</span>
                        <div class="toggle-switch" id="db-modal-auto-toggle" onclick="toggleDbModalAutoRefresh()"></div>
                    </div>
                    <button class="modal-refresh-btn" id="db-modal-refresh-btn" onclick="refreshDatabaseModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="modal-close" onclick="closeDatabaseModal()">&times;</button>
                </div>
            </div>
            <div class="modal-tabs" id="db-modal-tabs">
                <div class="modal-tab active" onclick="switchDbModalTab('charts')">Charts</div>
                <div class="modal-tab" onclick="switchDbModalTab('deps')">Dependents</div>
            </div>
            <div class="modal-body" id="db-modal-body">
                <!-- Charts Tab -->
                <div class="modal-tab-content active" id="db-tab-charts">
                    <div class="chart-row">
                        <div class="chart-card">
                            <h4>Query Latency Over Time</h4>
                            <canvas id="db-latency-chart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>Query Volume Over Time</h4>
                            <canvas id="db-volume-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-card">
                            <h4>Error Rate Over Time</h4>
                            <canvas id="db-error-chart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>Slowest Queries</h4>
                            <table class="ops-table" id="db-queries-table">
                                <thead><tr><th>Service</th><th>Operation</th><th>Avg Latency</th><th>Error %</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Dependents Tab -->
                <div class="modal-tab-content" id="db-tab-deps">
                    <div class="chart-card">
                        <h4>Services Using This Database</h4>
                        <div class="deps-list" id="db-dependents">
                            <div class="empty-state">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Drill-down Modal -->
    <div class="modal-overlay" id="error-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <span class="modal-type-badge error">Error</span>
                    <h2 id="error-modal-title">Error Details</h2>
                </div>
                <div class="modal-refresh-controls">
                    <button class="modal-close" onclick="closeErrorModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="error-modal-body">
                <div class="error-detail-card">
                    <h4>Error Information</h4>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Service:</span>
                        <span class="error-detail-value" id="error-service">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Operation:</span>
                        <span class="error-detail-value" id="error-operation">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Timestamp:</span>
                        <span class="error-detail-value" id="error-timestamp">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Duration:</span>
                        <span class="error-detail-value" id="error-duration">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Trace ID:</span>
                        <span class="error-detail-value" id="error-trace-id">-</span>
                    </div>
                </div>

                <div class="error-detail-card" id="exception-card" style="display: none;">
                    <h4>Exception Details</h4>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Type:</span>
                        <span class="error-detail-value error-text" id="exception-type">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Message:</span>
                        <span class="error-detail-value error-text" id="exception-message">-</span>
                    </div>
                </div>

                <div class="error-detail-card">
                    <h4>Full Trace</h4>
                    <div style="overflow-x: auto;">
                        <table class="trace-table" id="trace-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Operation</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Host Drill-down Modal -->
    <div class="modal-overlay" id="host-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <span class="modal-type-badge host" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">Host</span>
                    <h2 id="host-modal-title">Loading...</h2>
                </div>
                <div class="modal-refresh-controls">
                    <div class="auto-refresh-indicator" id="host-modal-auto-indicator">
                        <span class="dot"></span>
                        <span>Auto-refresh off</span>
                    </div>
                    <div class="toggle-container">
                        <span class="toggle-label">Auto</span>
                        <div class="toggle-switch" id="host-modal-auto-toggle" onclick="toggleHostModalAutoRefresh()"></div>
                    </div>
                    <button class="modal-refresh-btn" id="host-modal-refresh-btn" onclick="refreshHostModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="modal-close" onclick="closeHostModal()">&times;</button>
                </div>
            </div>
            <div class="modal-tabs" id="host-modal-tabs">
                <div class="modal-tab active" onclick="switchHostModalTab('metrics')">Metrics</div>
                <div class="modal-tab" onclick="switchHostModalTab('services')">Services</div>
            </div>
            <div class="modal-body" id="host-modal-body">
                <!-- Metrics Tab -->
                <div class="modal-tab-content active" id="host-tab-metrics">
                    <div class="chart-row">
                        <div class="chart-card">
                            <h4>Current Resource Usage</h4>
                            <div class="host-detail-metrics" id="host-current-metrics">
                                <div class="empty-state">Loading...</div>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Host Information</h4>
                            <div class="host-info" id="host-info">
                                <div class="empty-state">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Tab -->
                <div class="modal-tab-content" id="host-tab-services">
                    <div class="chart-card">
                        <h4>Services Running on This Host</h4>
                        <div class="deps-list" id="host-services">
                            <div class="empty-state">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal with Architecture Diagram -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal help-modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <h2>System Architecture</h2>
                </div>
                <div class="modal-refresh-controls">
                    <button class="modal-close" onclick="closeHelpModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body help-body">
                <div class="architecture-diagram">
                    <div class="arch-row">
                        <div class="arch-component apps">
                            <div class="arch-icon"></div>
                            <div class="arch-label">OTel Demo Apps</div>
                            <div class="arch-desc">Instrumented services generating telemetry</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component collector">
                            <div class="arch-icon"></div>
                            <div class="arch-label">OTel Collector</div>
                            <div class="arch-desc">Receives, processes, exports telemetry</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component kafka">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Vast Kafka</div>
                            <div class="arch-desc">Message broker (3 topics)</div>
                        </div>
                    </div>
                    <div class="arch-row">
                        <div class="arch-component ingester">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Ingester</div>
                            <div class="arch-desc">Consumes Kafka, writes to DB</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component database">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Vast DB</div>
                            <div class="arch-desc">Stores logs, metrics, traces</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component trino">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Trino</div>
                            <div class="arch-desc">SQL query engine</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component ui">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Agentic UI</div>
                            <div class="arch-desc">AI-powered diagnostics</div>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3> Data Flow</h3>
                    <div class="data-flow-cards">
                        <div class="flow-card traces">
                            <div class="flow-icon"></div>
                            <div class="flow-info">
                                <div class="flow-name">Traces</div>
                                <div class="flow-path">otel-traces  spans_otel_analytic</div>
                            </div>
                        </div>
                        <div class="flow-card metrics">
                            <div class="flow-icon"></div>
                            <div class="flow-info">
                                <div class="flow-name">Metrics</div>
                                <div class="flow-path">otel-metrics  metrics_otel_analytic</div>
                            </div>
                        </div>
                        <div class="flow-card logs">
                            <div class="flow-icon"></div>
                            <div class="flow-info">
                                <div class="flow-name">Logs</div>
                                <div class="flow-path">otel-logs  logs_otel_analytic</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3> How It Works</h3>
                    <ol class="how-it-works">
                        <li><strong>Ask a question</strong> in natural language (e.g., "Why is checkout slow?")</li>
                        <li><strong>AI generates SQL</strong> queries to investigate logs, metrics, and traces</li>
                        <li><strong>Queries run via Trino</strong> against Vast DB observability data</li>
                        <li><strong>AI analyzes results</strong> and follows the diagnostic process</li>
                        <li><strong>Root cause identified</strong> with supporting evidence</li>
                    </ol>
                </div>

                <div class="help-section">
                    <h3> Diagnostic Process</h3>
                    <div class="diagnostic-steps">
                        <div class="diag-step">
                            <span class="step-num">1</span>
                            <span class="step-text">Check infrastructure health (databases, hosts, services)</span>
                        </div>
                        <div class="diag-step">
                            <span class="step-num">2</span>
                            <span class="step-text">Look for connection errors, timeouts, missing telemetry</span>
                        </div>
                        <div class="diag-step">
                            <span class="step-num">3</span>
                            <span class="step-text">Trace errors through the dependency chain</span>
                        </div>
                        <div class="diag-step">
                            <span class="step-num">4</span>
                            <span class="step-text">Identify the root cause component</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Detail Modal -->
    <div class="modal-overlay" id="alert-modal">
        <div class="modal alert-modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <h2>Alert Details</h2>
                </div>
                <div class="modal-refresh-controls">
                    <button class="modal-close" onclick="closeAlertModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="alert-modal-content">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let isLoading = false;
        let modalCharts = {};
        let chatCharts = [];

        // Auto-refresh state
        let sidebarAutoRefresh = true;
        let sidebarRefreshInterval = null;
        let modalAutoRefresh = false;
        let modalRefreshInterval = null;
        let currentModalService = null;
        let dbModalAutoRefresh = false;
        let dbModalRefreshInterval = null;
        let currentModalDatabase = null;
        let hostModalAutoRefresh = false;
        let hostModalRefreshInterval = null;
        let currentModalHost = null;
        let availableServices = [];
        let availableDatabases = [];
        let alertsConfig = { investigate_critical_only: false };
        const REFRESH_INTERVAL = 15000; // 15 seconds for faster error detection

        const chartColors = ['#00d9ff', '#7c3aed', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];

        Chart.defaults.color = '#a0a0b0';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.06)';

        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch alerts config
            try {
                const configResp = await fetch('/api/alerts/config');
                alertsConfig = await configResp.json();
            } catch (e) {
                console.error('Failed to fetch alerts config:', e);
            }
            refreshStatus();
            startSidebarAutoRefresh();
        });

        function startSidebarAutoRefresh() {
            if (sidebarRefreshInterval) clearInterval(sidebarRefreshInterval);
            if (sidebarAutoRefresh) {
                sidebarRefreshInterval = setInterval(refreshStatus, REFRESH_INTERVAL);
            }
        }

        function toggleErrorsList() {
            const errorsList = document.getElementById('errors-list');
            const errorSummary = document.getElementById('error-summary');
            const expandHint = errorSummary.querySelector('.expand-hint');

            if (errorsList.classList.contains('errors-list-expanded')) {
                errorsList.className = 'errors-list-collapsed';
                if (expandHint) expandHint.textContent = 'Click to expand';
            } else {
                errorsList.className = 'errors-list-expanded';
                if (expandHint) expandHint.textContent = 'Click to collapse';
            }
        }

        function toggleSidebarAutoRefresh() {
            sidebarAutoRefresh = !sidebarAutoRefresh;
            const toggle = document.getElementById('sidebar-auto-toggle');
            toggle.classList.toggle('active', sidebarAutoRefresh);

            if (sidebarAutoRefresh) {
                startSidebarAutoRefresh();
            } else {
                if (sidebarRefreshInterval) {
                    clearInterval(sidebarRefreshInterval);
                    sidebarRefreshInterval = null;
                }
            }
        }

        function toggleModalAutoRefresh() {
            modalAutoRefresh = !modalAutoRefresh;
            const toggle = document.getElementById('modal-auto-toggle');
            const indicator = document.getElementById('modal-auto-indicator');

            toggle.classList.toggle('active', modalAutoRefresh);
            indicator.classList.toggle('active', modalAutoRefresh);
            indicator.querySelector('span:last-child').textContent = modalAutoRefresh ? 'Auto-refresh on' : 'Auto-refresh off';

            if (modalAutoRefresh && currentModalService) {
                startModalAutoRefresh();
            } else {
                stopModalAutoRefresh();
            }
        }

        function startModalAutoRefresh() {
            if (modalRefreshInterval) clearInterval(modalRefreshInterval);
            if (modalAutoRefresh && currentModalService) {
                modalRefreshInterval = setInterval(() => refreshServiceModal(), REFRESH_INTERVAL);
            }
        }

        function stopModalAutoRefresh() {
            if (modalRefreshInterval) {
                clearInterval(modalRefreshInterval);
                modalRefreshInterval = null;
            }
        }

        async function refreshServiceModal() {
            if (!currentModalService) return;

            const btn = document.getElementById('modal-refresh-btn');
            btn.classList.add('spinning');

            await loadServiceData(currentModalService);

            btn.classList.remove('spinning');
        }

        function setPrompt(text) {
            const input = document.getElementById('message-input');
            input.value = text;
            input.focus();
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            document.getElementById('send-btn').disabled = true;
            addMessage('user', message);
            input.value = '';

            const loadingId = addLoading();
            let completedQueries = [];

            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, session_id: sessionId })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleStreamEvent(loadingId, data, completedQueries);
                            } catch (e) {
                                console.error('Failed to parse SSE data:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                removeLoading(loadingId);
                addMessage('assistant', `Error: ${error.message}`);
            }

            isLoading = false;
            document.getElementById('send-btn').disabled = false;
            refreshStatus();
        }

        function handleStreamEvent(loadingId, data, completedQueries) {
            const loadingDiv = document.getElementById(loadingId);
            if (!loadingDiv) return;

            if (data.type === 'status') {
                updateLoadingProgress(loadingDiv, data.message, data.step, data.detail, completedQueries);
            } else if (data.type === 'query_result') {
                completedQueries.push({
                    index: data.query_index,
                    rows: data.row_count,
                    success: data.success
                });
                updateLoadingQueries(loadingDiv, completedQueries);
            } else if (data.type === 'complete') {
                removeLoading(loadingId);
                addMessage('assistant', data.response, data.queries, data.charts, data.topologies);
            } else if (data.type === 'error') {
                removeLoading(loadingId);
                addMessage('assistant', `Error: ${data.message}`);
            }
        }

        function updateLoadingProgress(loadingDiv, message, step, detail, completedQueries) {
            const progressContainer = loadingDiv.querySelector('.progress-container');
            if (!progressContainer) return;

            const progressMessage = progressContainer.querySelector('.progress-message');
            const progressDetail = progressContainer.querySelector('.progress-detail');
            const stepDots = progressContainer.querySelectorAll('.progress-step-dot');

            if (progressMessage) progressMessage.textContent = message;

            if (detail) {
                if (progressDetail) {
                    progressDetail.textContent = detail;
                    progressDetail.style.display = 'block';
                }
            } else if (progressDetail) {
                progressDetail.style.display = 'none';
            }

            // Update step dots
            stepDots.forEach((dot, i) => {
                if (i < step - 1) {
                    dot.className = 'progress-step-dot completed';
                } else if (i === step - 1) {
                    dot.className = 'progress-step-dot active';
                } else {
                    dot.className = 'progress-step-dot';
                }
            });
        }

        function updateLoadingQueries(loadingDiv, completedQueries) {
            const queriesContainer = loadingDiv.querySelector('.queries-progress');
            if (!queriesContainer) return;

            queriesContainer.innerHTML = completedQueries.map(q =>
                `<div class="query-progress-item">
                    <span class="check">${q.success ? '' : ''}</span>
                    <span>Query ${q.index + 1}</span>
                    <span class="rows">${q.rows} rows</span>
                </div>`
            ).join('');
        }

        function addMessage(role, content, queries = [], charts = [], topologies = []) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            let queriesHtml = '';
            if (queries && queries.length > 0) {
                queriesHtml = queries.map((q, i) => `
                    <div class="query-block">
                        <div class="query-header" onclick="toggleQuery(this)">
                            <span>Query ${i + 1}: ${q.result.row_count || 0} rows</span>
                            <span>&#9662;</span>
                        </div>
                        <div class="query-content" style="display: none;">
                            <div class="query-sql">${escapeHtml(q.sql)}</div>
                            <div class="query-results">${formatQueryResults(q.result)}</div>
                        </div>
                    </div>
                `).join('');
            }

            let chartsHtml = '';
            if (charts && charts.length > 0) {
                chartsHtml = charts.map((chart, i) => {
                    const chartId = `chat-chart-${Date.now()}-${i}`;
                    setTimeout(() => renderChart(chartId, chart), 100);
                    return `<div class="chart-container"><canvas id="${chartId}"></canvas></div>`;
                }).join('');
            }

            let topologiesHtml = '';
            if (topologies && topologies.length > 0) {
                topologiesHtml = topologies.map((topo, i) => {
                    const topoId = `topology-${Date.now()}-${i}`;
                    setTimeout(() => renderTopology(topoId, topo), 100);
                    return `
                        <div class="topology-container">
                            <div class="topology-title">${escapeHtml(topo.title)}</div>
                            <div class="topology-graph" id="${topoId}"></div>
                            <div class="topology-legend">
                                <div class="legend-item"><div class="legend-dot service"></div>Service</div>
                                <div class="legend-item"><div class="legend-dot database"></div>Database</div>
                                <div class="legend-item"><div class="legend-dot external"></div>External</div>
                                <div class="legend-item"><div class="legend-dot error"></div>Error</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            messageDiv.innerHTML = `
                <div class="message-label">${role === 'user' ? 'You' : 'Assistant'}</div>
                <div class="message-content">${formatMarkdown(content)}</div>
                ${chartsHtml}
                ${topologiesHtml}
                ${queriesHtml}
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function renderChart(canvasId, chartData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const datasets = chartData.datasets.map((ds, i) => ({
                label: ds.label,
                data: ds.data,
                borderColor: ds.color || chartColors[i % chartColors.length],
                backgroundColor: chartData.chart_type === 'line'
                    ? 'transparent'
                    : (ds.color || chartColors[i % chartColors.length]) + '40',
                tension: 0.4,
                fill: chartData.chart_type === 'line' ? false : true,
                pointRadius: 3,
                pointHoverRadius: 6
            }));

            new Chart(ctx, {
                type: chartData.chart_type,
                data: { labels: chartData.labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: { display: true, text: chartData.title, color: '#00d9ff', font: { size: 14, weight: 600 } },
                        legend: { labels: { color: '#a0a0b0', font: { size: 11 } } }
                    },
                    scales: chartData.chart_type !== 'doughnut' ? {
                        x: { ticks: { color: '#606070' }, grid: { color: 'rgba(255,255,255,0.04)' } },
                        y: { ticks: { color: '#606070' }, grid: { color: 'rgba(255,255,255,0.04)' } }
                    } : undefined
                }
            });
        }

        function renderTopology(containerId, topoData) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Node colors by type and status
            const nodeColors = {
                service: { background: '#00d9ff', border: '#00a3cc', font: '#ffffff' },
                database: { background: '#7c3aed', border: '#5b21b6', font: '#ffffff' },
                external: { background: '#f59e0b', border: '#d97706', font: '#ffffff' }
            };

            const statusColors = {
                healthy: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            };

            // Convert nodes to vis.js format
            const nodes = new vis.DataSet(topoData.nodes.map(node => {
                const typeColor = nodeColors[node.type] || nodeColors.service;
                const borderColor = node.status === 'error' ? statusColors.error :
                                   node.status === 'warning' ? statusColors.warning : typeColor.border;
                return {
                    id: node.id,
                    label: node.label,
                    color: {
                        background: typeColor.background,
                        border: borderColor,
                        highlight: { background: typeColor.background, border: '#ffffff' }
                    },
                    font: { color: typeColor.font, size: 12, face: 'Inter' },
                    shape: node.type === 'database' ? 'database' : 'box',
                    borderWidth: node.status ? 3 : 2,
                    shadow: true
                };
            }));

            // Convert edges to vis.js format
            const edges = new vis.DataSet(topoData.edges.map(edge => ({
                from: edge.from,
                to: edge.to,
                label: edge.label || '',
                arrows: 'to',
                color: { color: '#606070', highlight: '#00d9ff' },
                font: { color: '#a0a0b0', size: 10, face: 'Inter', strokeWidth: 0 },
                smooth: { type: 'cubicBezier', roundness: 0.5 }
            })));

            // Create the network
            const options = {
                physics: {
                    stabilization: { iterations: 100 },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.3,
                        springLength: 150,
                        springConstant: 0.04
                    }
                },
                layout: {
                    improvedLayout: true
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };

            new vis.Network(container, { nodes, edges }, options);
        }

        function addLoading() {
            const container = document.getElementById('chat-container');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading_' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-label">Assistant</div>
                <div class="message-content">
                    <div class="progress-container">
                        <div class="progress-header">
                            <div class="progress-spinner"></div>
                            <span class="progress-step">Working</span>
                        </div>
                        <div class="progress-message">Starting analysis...</div>
                        <div class="progress-detail" style="display: none;"></div>
                        <div class="queries-progress"></div>
                        <div class="progress-steps">
                            <div class="progress-step-dot active"></div>
                            <div class="progress-step-dot"></div>
                            <div class="progress-step-dot"></div>
                            <div class="progress-step-dot"></div>
                            <div class="progress-step-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            return loadingId;
        }

        function removeLoading(loadingId) {
            const loading = document.getElementById(loadingId);
            if (loading) loading.remove();
        }

        function toggleQuery(header) {
            const content = header.nextElementSibling;
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }

        function formatQueryResults(result) {
            if (!result.success) return `<div style="color: var(--accent-error);">Error: ${result.error}</div>`;
            if (!result.rows || result.rows.length === 0) return '<div class="empty-state">No results</div>';

            const columns = result.columns;
            const rows = result.rows.slice(0, 20);

            let html = '<table><thead><tr>';
            columns.forEach(col => { html += `<th>${escapeHtml(col)}</th>`; });
            html += '</tr></thead><tbody>';

            rows.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const val = row[col] !== null ? String(row[col]) : '';
                    html += `<td title="${escapeHtml(val)}">${escapeHtml(val.substring(0, 50))}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            if (result.rows.length > 20) html += `<div class="empty-state">Showing 20 of ${result.rows.length} rows</div>`;
            return html;
        }

        function formatMarkdown(text) {
            if (!text) return '';
            text = escapeHtml(text);

            // Code blocks first (preserve content)
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Headers
            text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');

            // Bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Normalize multiple newlines between list items to single newline
            text = text.replace(/(\n[ \t]*[-*])/g, '\n$1');
            text = text.replace(/(\n[ \t]*\d+[\.\)])/g, '\n$1');

            // Lists - convert to temp markers, strip extra whitespace
            // Note: Using <oli>/<uli> tags instead of {{OLI}}/{{ULI}} to avoid Jinja2 conflicts
            text = text.replace(/^[ \t]*(\d+)[\.\)] (.*$)/gm, '<oli>$2</oli>');
            text = text.replace(/^[ \t]*[a-z][\.\)] (.*$)/gm, '<oli>$1</oli>');
            text = text.replace(/^[ \t]*[-*] (.*$)/gm, '<uli>$1</uli>');

            // Wrap consecutive list items (handling newlines between them)
            text = text.replace(/((?:<oli>.*?<\/oli>\n*)+)/g, '<ol>$1</ol>');
            text = text.replace(/((?:<uli>.*?<\/uli>\n*)+)/g, '<ul>$1</ul>');

            // Convert markers to actual tags
            text = text.replace(/<oli>/g, '<li>').replace(/<\/oli>/g, '</li>');
            text = text.replace(/<uli>/g, '<li>').replace(/<\/uli>/g, '</li>');

            // Clean whitespace inside lists
            text = text.replace(/<\/li>\s+<li>/g, '</li><li>');
            text = text.replace(/<\/li>\s+<\/ol>/g, '</li></ol>');
            text = text.replace(/<\/li>\s+<\/ul>/g, '</li></ul>');
            text = text.replace(/<ol>\s+<li>/g, '<ol><li>');
            text = text.replace(/<ul>\s+<li>/g, '<ul><li>');

            // Paragraphs - only outside of lists
            text = text.replace(/\n\n+/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            text = '<p>' + text + '</p>';

            // Clean up
            text = text.replace(/<p><\/p>/g, '');
            text = text.replace(/<p>(<h[123]>)/g, '$1');
            text = text.replace(/(<\/h[123]>)<\/p>/g, '$1');
            text = text.replace(/<p>(<[ou]l>)/g, '$1');
            text = text.replace(/(<\/[ou]l>)<\/p>/g, '$1');
            text = text.replace(/<p>(<pre>)/g, '$1');
            text = text.replace(/(<\/pre>)<\/p>/g, '$1');
            text = text.replace(/<p>\s*<\/p>/g, '');
            text = text.replace(/<br>\s*(<[ou]l>)/g, '$1');
            text = text.replace(/(<\/[ou]l>)\s*<br>/g, '$1');
            text = text.replace(/<p><br>/g, '<p>');
            text = text.replace(/<br><\/p>/g, '</p>');

            // Highlight questions to the user (paragraphs ending with ?)
            // This helps differentiate agent questions from informational content
            text = text.replace(/<p>([^<]*\?)<\/p>/g, '<p class="agent-question">$1</p>');

            return text;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function clearChat() {
            await fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            });

            chatCharts.forEach(chart => chart.destroy());
            chatCharts = [];

            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div class="message assistant">
                    <div class="message-label">Assistant</div>
                    <div class="message-content">
                        <p>Chat cleared. How can I help you investigate issues?</p>
                    </div>
                </div>
            `;
        }

        async function refreshStatus() {
            try {
                // Get selected time window for services
                const timeSelector = document.getElementById('services-time-selector');
                const timeWindow = timeSelector ? timeSelector.value : '5m';

                const response = await fetch(`/api/status?time=${timeWindow}`);
                const data = await response.json();

                const servicesList = document.getElementById('services-list');
                if (data.services && data.services.length > 0) {
                    // Sort services alphabetically by name and store for dropdown
                    const sortedServices = [...data.services].sort((a, b) =>
                        a.service_name.localeCompare(b.service_name)
                    );
                    availableServices = sortedServices.map(s => s.service_name);
                    servicesList.innerHTML = sortedServices.map(s => {
                        const totalSpans = parseInt(s.total_spans) || 0;
                        const errorPct = parseFloat(s.error_pct) || 0;
                        let statusClass = 'status-healthy';
                        let statusText = 'OK';

                        if (totalSpans === 0) {
                            statusClass = 'status-warning';
                            statusText = 'no data';
                        } else if (errorPct > 10) {
                            statusClass = 'status-error';
                            statusText = `${errorPct}% err`;
                        } else if (errorPct > 1) {
                            statusClass = 'status-warning';
                            statusText = `${errorPct}% err`;
                        }
                        return `
                            <div class="service-item" onclick="openServiceModal('${s.service_name}')">
                                <span class="service-name">${s.service_name}</span>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    availableServices = [];
                    servicesList.innerHTML = '<div class="empty-state">No service data</div>';
                }

                const dbList = document.getElementById('databases-list');
                if (data.databases && data.databases.length > 0) {
                    // Sort databases alphabetically and store for dropdown
                    const sortedDbs = [...data.databases].sort((a, b) =>
                        a.db_system.localeCompare(b.db_system)
                    );
                    availableDatabases = sortedDbs.map(db => db.db_system);
                    dbList.innerHTML = sortedDbs.map(db => `
                        <div class="service-item" onclick="openDatabaseModal('${db.db_system}')">
                            <span class="service-name">${db.db_system}</span>
                            <span class="status-badge status-healthy">${db.span_count}</span>
                        </div>
                    `).join('');
                } else {
                    availableDatabases = [];
                    dbList.innerHTML = '<div class="empty-state" style="color: var(--accent-error);">No database spans!</div>';
                }

                // Host metrics
                const hostsList = document.getElementById('hosts-list');
                if (data.hosts && data.hosts.length > 0) {
                    hostsList.innerHTML = data.hosts.map(h => {
                        const cpu = h.cpu_pct !== null ? h.cpu_pct : '-';
                        const mem = h.memory_pct !== null ? h.memory_pct : '-';
                        const disk = h.disk_pct !== null ? h.disk_pct : '-';

                        const cpuClass = cpu === '-' ? '' : (cpu > 80 ? 'metric-error' : cpu > 60 ? 'metric-warn' : 'metric-ok');
                        const memClass = mem === '-' ? '' : (mem > 85 ? 'metric-error' : mem > 70 ? 'metric-warn' : 'metric-ok');
                        const diskClass = disk === '-' ? '' : (disk > 90 ? 'metric-error' : disk > 75 ? 'metric-warn' : 'metric-ok');

                        return `
                            <div class="host-item" onclick="openHostModal('${escapeHtml(h.host_name)}')" style="cursor: pointer;">
                                <div class="host-name">${escapeHtml(h.host_name)}</div>
                                <div class="host-metrics">
                                    <div class="host-metric">
                                        <div class="host-metric-value ${cpuClass}">${cpu}%</div>
                                        <div class="host-metric-label">CPU</div>
                                    </div>
                                    <div class="host-metric">
                                        <div class="host-metric-value ${memClass}">${mem}%</div>
                                        <div class="host-metric-label">MEM</div>
                                    </div>
                                    <div class="host-metric">
                                        <div class="host-metric-value ${diskClass}">${disk}%</div>
                                        <div class="host-metric-label">DISK</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    hostsList.innerHTML = '<div class="empty-state">No host metrics</div>';
                }

                // Error summary card
                const errorSummary = document.getElementById('error-summary');
                const errorsList = document.getElementById('errors-list');
                const totalErrors = data.error_summary?.total_errors || 0;
                const affectedServices = data.error_summary?.affected_services || 0;

                if (totalErrors > 0) {
                    errorSummary.className = 'error-summary-card has-errors';
                    errorSummary.innerHTML = `
                        <div class="error-summary-stats">
                            <div>
                                <div class="error-count">${totalErrors}</div>
                                <div class="error-label">errors (5m)</div>
                            </div>
                            <div class="error-services">
                                <div class="error-services-count">${affectedServices}</div>
                                <div class="error-label">services</div>
                            </div>
                        </div>
                        <div class="expand-hint">Click to ${errorsList.classList.contains('errors-list-expanded') ? 'collapse' : 'expand'}</div>
                    `;
                    errorSummary.onclick = toggleErrorsList;

                    // Populate errors list
                    if (data.recent_errors && data.recent_errors.length > 0) {
                        errorsList.innerHTML = data.recent_errors.map(e => `
                            <div class="error-item" onclick="event.stopPropagation(); openErrorModal('${e.trace_id}', '${e.span_id}')">
                                <div class="error-service">${e.service_name}</div>
                                <div class="error-span">${e.span_name}</div>
                            </div>
                        `).join('');
                    }
                } else {
                    errorSummary.className = 'error-summary-card no-errors';
                    errorSummary.innerHTML = `
                        <div class="error-summary-stats">
                            <div>
                                <div class="error-count zero">0</div>
                                <div class="error-label">errors (5m)</div>
                            </div>
                        </div>
                    `;
                    errorSummary.onclick = null;
                    errorsList.innerHTML = '';
                    errorsList.className = 'errors-list-collapsed';
                }

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

                // Also refresh alerts and activity
                await refreshAlerts();
                await refreshActivity();

            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }

        async function refreshAlerts() {
            try {
                const response = await fetch('/api/alerts?status=active&limit=10');
                const data = await response.json();

                const alertsList = document.getElementById('alerts-list');
                const alertsBadge = document.getElementById('alerts-badge');

                // Update badge
                const totalActive = data.summary?.active || 0;
                if (totalActive > 0) {
                    alertsBadge.textContent = totalActive;
                    alertsBadge.style.display = 'inline';

                    // Change badge color based on severity
                    if (data.summary.critical > 0) {
                        alertsBadge.style.background = 'var(--accent-error)';
                    } else if (data.summary.warning > 0) {
                        alertsBadge.style.background = 'var(--accent-warning)';
                    } else {
                        alertsBadge.style.background = 'var(--accent-primary)';
                    }
                } else {
                    alertsBadge.style.display = 'none';
                }

                // Update alerts list and cache for investigation lookup
                if (data.alerts && data.alerts.length > 0) {
                    // Cache alerts by ID for investigation lookup
                    window.alertsCache = {};
                    data.alerts.forEach(alert => {
                        window.alertsCache[alert.alert_id] = alert;
                    });

                    alertsList.innerHTML = data.alerts.map(alert => {
                        const severity = alert.severity || 'info';
                        const timeAgo = formatTimeAgo(alert.created_at);
                        const hasInvestigation = alert.root_cause_summary;
                        const isRootCauseAlert = isRootCauseAlertType(alert.alert_type);
                        const categoryLabel = isRootCauseAlert ? 'ROOT CAUSE' : 'SYMPTOM';
                        const categoryClass = isRootCauseAlert ? 'root-cause' : 'symptom';

                        return `
                            <div class="alert-item alert-${severity}" onclick="investigateAlert('${escapeHtml(alert.alert_id)}')">
                                <div class="alert-header">
                                    <span class="alert-severity ${severity}">${severity}</span>
                                    <span class="alert-category ${categoryClass}">${categoryLabel}</span>
                                    <span class="alert-time">${timeAgo}${hasInvestigation ? '  analyzed' : ''}</span>
                                </div>
                                <div class="alert-title">${escapeHtml(alert.title || alert.alert_type)}</div>
                                ${hasInvestigation
                                    ? `<div class="alert-root-cause">${escapeHtml(alert.root_cause_summary)}</div>`
                                    : `<div class="alert-description">${escapeHtml(alert.description || '')}</div>`
                                }
                            </div>
                        `;
                    }).join('');
                } else {
                    alertsList.innerHTML = `
                        <div class="empty-state" style="color: var(--accent-success);">
                            No active alerts
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to refresh alerts:', error);
                document.getElementById('alerts-list').innerHTML = '<div class="empty-state">Alerts unavailable</div>';
            }
        }

        // Root cause alert types - these indicate underlying issues that can lead to symptoms
        const ROOT_CAUSE_ALERT_TYPES = [
            'db_connection_failure',
            'db_slow_queries',
            'dependency_failure',
            'dependency_latency',
            'exception_surge',
            'new_exception_type'
        ];

        function isRootCauseAlertType(alertType) {
            return ROOT_CAUSE_ALERT_TYPES.includes(alertType);
        }

        function formatTimeAgo(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${Math.floor(diffHours / 24)}d ago`;
        }

        function investigateAlert(alertId) {
            // Look up alert from cache and open modal
            const alert = window.alertsCache ? window.alertsCache[alertId] : null;
            openAlertModal(alert, alertId);
        }

        function openAlertModal(alert, alertId) {
            const modal = document.getElementById('alert-modal');
            const content = document.getElementById('alert-modal-content');

            if (!alert) {
                content.innerHTML = `
                    <div class="alert-no-investigation">
                        <div class="alert-no-investigation-icon"></div>
                        <div class="alert-no-investigation-text">Alert not found in cache</div>
                        <button class="alert-action-btn primary" onclick="askAboutAlert('${alertId}')">
                            Investigate via Chat
                        </button>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            const severity = alert.severity || 'info';
            const alertType = (alert.alert_type || '').replace(/_/g, ' ');
            const hasInvestigation = alert.root_cause_summary;
            const createdAt = alert.created_at ? new Date(alert.created_at).toLocaleString() : 'Unknown';
            const isRootCause = isRootCauseAlertType(alert.alert_type);
            const categoryLabel = isRootCause ? 'ROOT CAUSE' : 'SYMPTOM';
            const categoryClass = isRootCause ? 'root-cause' : 'symptom';

            let investigationHtml;
            if (hasInvestigation) {
                investigationHtml = `
                    <div class="alert-section">
                        <div class="alert-section-title"> Root Cause</div>
                        <div class="alert-section-content root-cause">
                            ${escapeHtml(alert.root_cause_summary)}
                        </div>
                    </div>

                    ${alert.recommended_actions ? `
                    <div class="alert-section">
                        <div class="alert-section-title"> Recommended Actions</div>
                        <div class="alert-section-content actions">
                            ${escapeHtml(alert.recommended_actions).replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    ` : ''}

                    ${alert.supporting_evidence ? `
                    <div class="alert-section">
                        <div class="alert-section-title"> Supporting Evidence</div>
                        <div class="alert-section-content evidence">
${escapeHtml(alert.supporting_evidence)}</div>
                    </div>
                    ` : ''}

                    <div class="alert-investigation-stats">
                        ${alert.queries_executed ? `<span> ${alert.queries_executed} queries</span>` : ''}
                        ${alert.tokens_used ? `<span> ${alert.tokens_used} tokens</span>` : ''}
                        ${alert.model_used ? `<span> ${alert.model_used}</span>` : ''}
                    </div>
                `;
            } else {
                // Determine why no investigation exists
                const isNonCritical = severity !== 'critical';
                const criticalOnlyMode = alertsConfig.investigate_critical_only;

                let noInvestigationReason;
                if (criticalOnlyMode && isNonCritical) {
                    noInvestigationReason = `Auto-investigation is configured for <strong>critical alerts only</strong>.<br>
                        This ${severity} alert was not automatically investigated.`;
                } else {
                    noInvestigationReason = `No investigation available yet.<br>
                        The automated system may be rate-limited or processing other alerts.`;
                }

                investigationHtml = `
                    <div class="alert-no-investigation">
                        <div class="alert-no-investigation-icon"></div>
                        <div class="alert-no-investigation-text">
                            ${noInvestigationReason}
                        </div>
                        <button class="alert-action-btn primary" onclick="requestInvestigation('${escapeHtml(alert.alert_id)}')" id="investigate-btn-${escapeHtml(alert.alert_id)}">
                            Request Investigation
                        </button>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="alert-detail-header">
                    <span class="alert-detail-severity ${severity}">${severity}</span>
                    <span class="alert-category ${categoryClass}" style="margin-left: 8px;">${categoryLabel}</span>
                    <span class="alert-detail-title">${escapeHtml(alert.title || alertType)}</span>
                </div>

                <div class="alert-detail-meta">
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Alert ID</span>
                        <span class="alert-meta-value" style="font-family: 'JetBrains Mono', monospace; font-size: 11px;">${escapeHtml(alert.alert_id)}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Service</span>
                        <span class="alert-meta-value">${escapeHtml(alert.service_name)}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Category</span>
                        <span class="alert-meta-value">${isRootCause ? 'Root Cause (proactive)' : 'Symptom (reactive)'}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Type</span>
                        <span class="alert-meta-value">${escapeHtml(alertType)}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Created</span>
                        <span class="alert-meta-value">${createdAt}</span>
                    </div>
                    ${alert.current_value ? `
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Current Value</span>
                        <span class="alert-meta-value">${typeof alert.current_value === 'number' ? alert.current_value.toFixed(2) : alert.current_value}</span>
                    </div>
                    ` : ''}
                    ${alert.baseline_value ? `
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Baseline</span>
                        <span class="alert-meta-value">${typeof alert.baseline_value === 'number' ? alert.baseline_value.toFixed(2) : alert.baseline_value}</span>
                    </div>
                    ` : ''}
                </div>

                ${alert.description ? `
                <div class="alert-section">
                    <div class="alert-section-title"> Description</div>
                    <div class="alert-section-content">
                        ${escapeHtml(alert.description)}
                    </div>
                </div>
                ` : ''}

                ${investigationHtml}

                <div class="alert-actions">
                    <button class="alert-action-btn secondary" onclick="closeAlertModal()">Close</button>
                    <button class="alert-action-btn warning" onclick="archiveAlert('${escapeHtml(alert.alert_id)}')">Archive</button>
                    <button class="alert-action-btn primary" onclick="askAboutAlert('${escapeHtml(alert.alert_id)}', '${escapeHtml(alert.service_name)}', '${escapeHtml(alertType)}', ${hasInvestigation ? 'true' : 'false'})">
                        ${hasInvestigation ? 'Ask Follow-up' : 'Investigate in Chat'}
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeAlertModal() {
            document.getElementById('alert-modal').classList.remove('active');
        }

        async function requestInvestigation(alertId) {
            const btn = document.getElementById(`investigate-btn-${alertId}`);
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Investigating...';
            }

            try {
                const response = await fetch(`/api/alerts/${alertId}/investigate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.success) {
                    // Update the cache with investigation results
                    if (window.alertsCache && window.alertsCache[alertId]) {
                        Object.assign(window.alertsCache[alertId], data.investigation);
                    }
                    // Refresh the modal to show results
                    const alert = window.alertsCache ? window.alertsCache[alertId] : null;
                    openAlertModal(alert, alertId);
                    // Refresh alerts list too
                    refreshAlerts();
                } else {
                    if (btn) {
                        btn.textContent = data.error || 'Failed';
                        btn.disabled = false;
                        setTimeout(() => {
                            btn.textContent = 'Request Investigation';
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Investigation request failed:', error);
                if (btn) {
                    btn.textContent = 'Error - Try Again';
                    btn.disabled = false;
                    setTimeout(() => {
                        btn.textContent = 'Request Investigation';
                    }, 3000);
                }
            }
        }

        async function archiveAlert(alertId) {
            try {
                const response = await fetch(`/api/alerts/${alertId}/archive`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.success) {
                    closeAlertModal();
                    // Remove from cache and refresh
                    if (window.alertsCache) {
                        delete window.alertsCache[alertId];
                    }
                    refreshAlerts();
                    refreshActivity();
                } else {
                    alert('Failed to archive: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Archive failed:', error);
                alert('Failed to archive alert');
            }
        }

        function askAboutAlert(alertId, serviceName, alertType, hasInvestigation) {
            closeAlertModal();
            const alert = window.alertsCache ? window.alertsCache[alertId] : null;

            let prompt;
            if (hasInvestigation && alert) {
                prompt = `I'm looking at a ${alertType} alert for ${serviceName}.

**Automated Analysis Found:**
${alert.root_cause_summary}

${alert.recommended_actions ? `**Recommended Actions:**
${alert.recommended_actions}` : ''}

Can you help me understand this issue further or suggest next steps?`;
            } else {
                prompt = `Investigate the ${alertType || 'alert'} for ${serviceName || 'this service'}. What's causing this issue?`;
            }

            setPrompt(prompt);
            sendMessage();
        }

        async function refreshActivity() {
            try {
                const response = await fetch('/api/alerts/activity?minutes=60&limit=15');
                const data = await response.json();
                const activityList = document.getElementById('activity-list');

                if (data.events && data.events.length > 0) {
                    activityList.innerHTML = data.events.map(event => {
                        const eventType = event.event_type;
                        const timeAgo = formatTimeAgo(event.event_time);
                        const service = escapeHtml(event.service_name || 'unknown');
                        const alertType = (event.alert_type || '').replace(/_/g, ' ');

                        let icon, text;
                        if (eventType === 'created') {
                            icon = '!';
                            text = `<strong>${service}</strong> ${alertType}`;
                        } else if (eventType === 'auto_resolved') {
                            icon = '';
                            text = `<strong>${service}</strong> ${alertType} auto-resolved`;
                        } else {
                            icon = '';
                            text = `<strong>${service}</strong> ${alertType} resolved`;
                        }

                        return `
                            <div class="activity-event">
                                <div class="activity-icon ${eventType}">${icon}</div>
                                <div class="activity-content">
                                    <div class="activity-text">${text}</div>
                                    <div class="activity-time">${timeAgo}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    activityList.innerHTML = '<div class="empty-state">No recent activity</div>';
                }
            } catch (error) {
                console.error('Failed to refresh activity:', error);
                document.getElementById('activity-list').innerHTML = '<div class="empty-state">Activity unavailable</div>';
            }
        }

        async function openServiceModal(serviceName) {
            currentModalService = serviceName;
            document.getElementById('service-modal').classList.add('active');

            // Populate service selector dropdown
            const selector = document.getElementById('service-selector');
            selector.innerHTML = availableServices.map(s =>
                `<option value="${s}" ${s === serviceName ? 'selected' : ''}>${s}</option>`
            ).join('');

            // Enable auto-refresh by default
            modalAutoRefresh = true;
            document.getElementById('modal-auto-toggle').classList.add('active');
            const indicator = document.getElementById('modal-auto-indicator');
            indicator.classList.add('active');
            indicator.querySelector('span:last-child').textContent = 'Auto-refresh on';

            await loadServiceData(serviceName);
            startModalAutoRefresh();
        }

        function switchService(serviceName) {
            if (serviceName && serviceName !== currentModalService) {
                currentModalService = serviceName;
                // Reset to charts tab when switching services
                switchModalTab('charts');
                loadServiceData(serviceName);
            }
        }

        async function loadServiceData(serviceName) {
            Object.values(modalCharts).forEach(chart => chart.destroy());
            modalCharts = {};

            try {
                const response = await fetch(`/api/service/${encodeURIComponent(serviceName)}?range=1`);
                const data = await response.json();

                if (data.latency_history && data.latency_history.length > 0) {
                    const labels = data.latency_history.map(r => {
                        const d = new Date(r.time_bucket);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    modalCharts.latency = new Chart(document.getElementById('latency-chart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Avg Latency (ms)', data: data.latency_history.map(r => r.avg_latency_ms), borderColor: '#00d9ff', tension: 0.4, fill: false, pointRadius: 2 },
                                { label: 'Max Latency (ms)', data: data.latency_history.map(r => r.max_latency_ms), borderColor: '#ef4444', tension: 0.4, fill: false, pointRadius: 2 }
                            ]
                        },
                        options: chartOptions()
                    });
                }

                if (data.error_history && data.error_history.length > 0) {
                    const labels = data.error_history.map(r => {
                        const d = new Date(r.time_bucket);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    modalCharts.errors = new Chart(document.getElementById('error-chart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Error %', data: data.error_history.map(r => r.error_pct), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                            ]
                        },
                        options: chartOptions()
                    });
                }

                if (data.latency_history && data.latency_history.length > 0) {
                    const labels = data.latency_history.map(r => {
                        const d = new Date(r.time_bucket);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    modalCharts.throughput = new Chart(document.getElementById('throughput-chart'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Requests', data: data.latency_history.map(r => r.request_count), backgroundColor: 'rgba(0,217,255,0.4)', borderColor: '#00d9ff', borderWidth: 1 }
                            ]
                        },
                        options: chartOptions()
                    });
                }

            } catch (error) {
                console.error('Failed to load service details:', error);
            }

            // Also load top operations with selected time window
            await refreshTopOperations();
        }

        async function refreshTopOperations() {
            if (!currentModalService) return;

            const timeSelector = document.getElementById('ops-time-selector');
            const timeWindow = timeSelector ? timeSelector.value : '5m';

            try {
                const response = await fetch(`/api/service/${encodeURIComponent(currentModalService)}/operations?time=${timeWindow}`);
                const data = await response.json();

                const opsTable = document.getElementById('ops-table').querySelector('tbody');
                if (data.operations && data.operations.length > 0) {
                    opsTable.innerHTML = data.operations.map(op => `
                        <tr>
                            <td title="${escapeHtml(op.span_name)}">${escapeHtml(op.span_name.substring(0, 30))}</td>
                            <td>${op.call_count}</td>
                            <td>${op.avg_latency_ms}ms</td>
                            <td style="color: ${op.error_pct > 5 ? 'var(--accent-error)' : 'inherit'}">${op.error_pct}%</td>
                        </tr>
                    `).join('');
                } else {
                    opsTable.innerHTML = '<tr><td colspan="4" class="empty-state">No data</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load top operations:', error);
            }
        }

        function chartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { labels: { color: '#a0a0b0', font: { size: 11 } } } },
                scales: {
                    x: { ticks: { color: '#606070', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#606070', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } }
                }
            };
        }

        function closeModal() {
            document.getElementById('service-modal').classList.remove('active');
            stopModalAutoRefresh();
            currentModalService = null;
            modalAutoRefresh = false;
            // Reset to charts tab
            switchModalTab('charts');
        }

        // Tab switching function for service modal
        function switchModalTab(tabName) {
            // Update tab buttons (specific to service modal)
            document.querySelectorAll('#service-modal .modal-tabs .modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`#service-modal .modal-tabs .modal-tab[onclick*="${tabName}"]`).classList.add('active');

            // Update tab content (specific to service modal)
            document.querySelectorAll('#service-modal .modal-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load data for the tab if needed
            if (tabName === 'traces' && currentModalService) {
                loadServiceTraces();
            } else if (tabName === 'logs' && currentModalService) {
                loadServiceLogs();
            } else if (tabName === 'metrics' && currentModalService) {
                loadServiceMetrics();
            } else if (tabName === 'deps' && currentModalService) {
                loadServiceDependencies();
            }
        }

        async function loadServiceDependencies() {
            if (!currentModalService) return;

            const upstreamDiv = document.getElementById('upstream-deps');
            const downstreamDiv = document.getElementById('downstream-deps');

            upstreamDiv.innerHTML = '<div class="empty-state">Loading...</div>';
            downstreamDiv.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const response = await fetch(`/api/service/${encodeURIComponent(currentModalService)}/dependencies?time=15m`);
                const data = await response.json();

                // Render upstream (what calls this service)
                if (data.upstream && data.upstream.length > 0) {
                    upstreamDiv.innerHTML = data.upstream.map(dep => `
                        <div class="dep-item" onclick="openServiceModal('${escapeHtml(dep.dependent)}')">
                            <div class="dep-name">
                                <span class="dep-type-badge ${dep.dep_type}">${dep.dep_type}</span>
                                ${escapeHtml(dep.dependent)}
                            </div>
                            <span class="dep-calls">${dep.call_count} calls</span>
                        </div>
                    `).join('');
                } else {
                    upstreamDiv.innerHTML = '<div class="empty-state">No upstream dependencies found</div>';
                }

                // Render downstream (what this service calls)
                if (data.downstream && data.downstream.length > 0) {
                    downstreamDiv.innerHTML = data.downstream.map(dep => `
                        <div class="dep-item" onclick="${dep.dep_type === 'database' ? `openDatabaseModal('${escapeHtml(dep.dependency)}')` : `openServiceModal('${escapeHtml(dep.dependency)}')`}">
                            <div class="dep-name">
                                <span class="dep-type-badge ${dep.dep_type}">${dep.dep_type}</span>
                                ${escapeHtml(dep.dependency)}
                            </div>
                            <span class="dep-calls">${dep.call_count} calls</span>
                        </div>
                    `).join('');
                } else {
                    downstreamDiv.innerHTML = '<div class="empty-state">No downstream dependencies found</div>';
                }
            } catch (error) {
                console.error('Failed to load dependencies:', error);
                upstreamDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
                downstreamDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
            }
        }

        async function loadServiceTraces() {
            if (!currentModalService) return;

            const timeSelector = document.getElementById('traces-time-selector');
            const timeWindow = timeSelector ? timeSelector.value : '5m';

            try {
                const response = await fetch(`/api/service/${encodeURIComponent(currentModalService)}/traces?time=${timeWindow}&limit=50`);
                const data = await response.json();

                const tbody = document.getElementById('traces-table').querySelector('tbody');
                const countBadge = document.getElementById('traces-count');

                if (data.traces && data.traces.length > 0) {
                    countBadge.textContent = data.traces.length;
                    tbody.innerHTML = data.traces.map(t => {
                        const time = t.start_time ? new Date(t.start_time).toLocaleTimeString() : '-';
                        const isError = t.status_code === 'ERROR';
                        return `
                            <tr class="${isError ? 'error-row' : ''}" onclick="openErrorModal('${t.trace_id}', '${t.span_id}')" style="cursor: pointer;">
                                <td>${time}</td>
                                <td title="${escapeHtml(t.span_name)}">${escapeHtml((t.span_name || '-').substring(0, 40))}</td>
                                <td>${t.span_kind || '-'}</td>
                                <td>${t.duration_ms}ms</td>
                                <td style="color: ${isError ? 'var(--accent-error)' : 'var(--accent-success)'}">${t.status_code || 'OK'}</td>
                                <td title="${t.trace_id}">${(t.trace_id || '').substring(0, 12)}...</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    countBadge.textContent = '0';
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No traces found</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load traces:', error);
            }
        }

        async function loadServiceLogs() {
            if (!currentModalService) return;

            const timeSelector = document.getElementById('logs-time-selector');
            const timeWindow = timeSelector ? timeSelector.value : '5m';

            try {
                const response = await fetch(`/api/service/${encodeURIComponent(currentModalService)}/logs?time=${timeWindow}&limit=50`);
                const data = await response.json();

                const tbody = document.getElementById('logs-table').querySelector('tbody');
                const countBadge = document.getElementById('logs-count');

                if (data.logs && data.logs.length > 0) {
                    countBadge.textContent = data.logs.length;
                    tbody.innerHTML = data.logs.map(log => {
                        const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '-';
                        const severity = (log.severity_text || 'INFO').toUpperCase();
                        const severityClass = severity === 'ERROR' ? 'severity-error' :
                                             severity === 'WARN' || severity === 'WARNING' ? 'severity-warn' :
                                             severity === 'DEBUG' ? 'severity-debug' : 'severity-info';
                        const isError = severity === 'ERROR';
                        return `
                            <tr class="${isError ? 'error-row' : ''}">
                                <td>${time}</td>
                                <td class="${severityClass}">${severity}</td>
                                <td class="log-body" title="${escapeHtml(log.body || '')}">${escapeHtml((log.body || '-').substring(0, 100))}</td>
                                <td title="${log.trace_id || ''}">${log.trace_id ? (log.trace_id.substring(0, 12) + '...') : '-'}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    countBadge.textContent = '0';
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No logs found</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
            }
        }

        async function loadServiceMetrics() {
            if (!currentModalService) return;

            const timeSelector = document.getElementById('metrics-time-selector');
            const timeWindow = timeSelector ? timeSelector.value : '5m';

            try {
                const response = await fetch(`/api/service/${encodeURIComponent(currentModalService)}/metrics?time=${timeWindow}&limit=50`);
                const data = await response.json();

                const tbody = document.getElementById('metrics-table').querySelector('tbody');
                const countBadge = document.getElementById('metrics-count');

                if (data.metrics && data.metrics.length > 0) {
                    countBadge.textContent = data.metrics.length;
                    tbody.innerHTML = data.metrics.map(m => {
                        const lastSeen = m.last_seen ? new Date(m.last_seen).toLocaleTimeString() : '-';
                        return `
                            <tr>
                                <td title="${escapeHtml(m.metric_name)}">${escapeHtml((m.metric_name || '-').substring(0, 40))}</td>
                                <td>${m.data_points}</td>
                                <td>${m.avg_value !== null ? m.avg_value : '-'}</td>
                                <td>${m.min_value !== null ? m.min_value : '-'}</td>
                                <td>${m.max_value !== null ? m.max_value : '-'}</td>
                                <td>${lastSeen}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    countBadge.textContent = '0';
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No metrics found</td></tr>';
                }
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        // Database Modal Functions
        let dbModalCharts = {};

        async function openDatabaseModal(dbSystem) {
            currentModalDatabase = dbSystem;
            document.getElementById('database-modal').classList.add('active');

            // Populate database selector dropdown
            const selector = document.getElementById('database-selector');
            selector.innerHTML = availableDatabases.map(db =>
                `<option value="${db}" ${db === dbSystem ? 'selected' : ''}>${db}</option>`
            ).join('');

            // Enable auto-refresh by default
            dbModalAutoRefresh = true;
            document.getElementById('db-modal-auto-toggle').classList.add('active');
            const indicator = document.getElementById('db-modal-auto-indicator');
            indicator.classList.add('active');
            indicator.querySelector('span:last-child').textContent = 'Auto-refresh on';

            await loadDatabaseData(dbSystem);
            startDbModalAutoRefresh();
        }

        function switchDatabase(dbSystem) {
            if (dbSystem && dbSystem !== currentModalDatabase) {
                currentModalDatabase = dbSystem;
                loadDatabaseData(dbSystem);
            }
        }

        async function loadDatabaseData(dbSystem) {
            Object.values(dbModalCharts).forEach(chart => chart.destroy());
            dbModalCharts = {};

            try {
                const response = await fetch(`/api/database/${encodeURIComponent(dbSystem)}?range=1`);
                const data = await response.json();

                // Latency chart
                if (data.latency_history && data.latency_history.length > 0) {
                    const labels = data.latency_history.map(r => {
                        const d = new Date(r.time_bucket);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    dbModalCharts.latency = new Chart(document.getElementById('db-latency-chart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Avg Latency (ms)', data: data.latency_history.map(r => r.avg_latency_ms), borderColor: '#7c3aed', tension: 0.4, fill: false, pointRadius: 2 },
                                { label: 'Max Latency (ms)', data: data.latency_history.map(r => r.max_latency_ms), borderColor: '#ef4444', tension: 0.4, fill: false, pointRadius: 2 }
                            ]
                        },
                        options: chartOptions()
                    });
                }

                // Volume chart
                if (data.latency_history && data.latency_history.length > 0) {
                    const labels = data.latency_history.map(r => {
                        const d = new Date(r.time_bucket);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    dbModalCharts.volume = new Chart(document.getElementById('db-volume-chart'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Queries', data: data.latency_history.map(r => r.query_count), backgroundColor: 'rgba(124,58,237,0.4)', borderColor: '#7c3aed', borderWidth: 1 }
                            ]
                        },
                        options: chartOptions()
                    });
                }

                // Error rate chart
                if (data.error_history && data.error_history.length > 0) {
                    const labels = data.error_history.map(r => {
                        const d = new Date(r.time_bucket);
                        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    });
                    dbModalCharts.errors = new Chart(document.getElementById('db-error-chart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Error %', data: data.error_history.map(r => r.error_pct), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                            ]
                        },
                        options: chartOptions()
                    });
                }

                // Slowest queries table
                const queriesTable = document.getElementById('db-queries-table').querySelector('tbody');
                if (data.slow_queries && data.slow_queries.length > 0) {
                    queriesTable.innerHTML = data.slow_queries.map(q => `
                        <tr>
                            <td title="${escapeHtml(q.service_name)}">${escapeHtml(q.service_name.substring(0, 20))}</td>
                            <td title="${escapeHtml(q.span_name)}">${escapeHtml(q.span_name.substring(0, 25))}</td>
                            <td>${q.avg_latency_ms}ms</td>
                            <td style="color: ${q.error_pct > 5 ? 'var(--accent-error)' : 'inherit'}">${q.error_pct}%</td>
                        </tr>
                    `).join('');
                } else {
                    queriesTable.innerHTML = '<tr><td colspan="4" class="empty-state">No data</td></tr>';
                }

            } catch (error) {
                console.error('Failed to load database details:', error);
            }
        }

        function toggleDbModalAutoRefresh() {
            dbModalAutoRefresh = !dbModalAutoRefresh;
            const toggle = document.getElementById('db-modal-auto-toggle');
            const indicator = document.getElementById('db-modal-auto-indicator');

            toggle.classList.toggle('active', dbModalAutoRefresh);
            indicator.classList.toggle('active', dbModalAutoRefresh);
            indicator.querySelector('span:last-child').textContent = dbModalAutoRefresh ? 'Auto-refresh on' : 'Auto-refresh off';

            if (dbModalAutoRefresh && currentModalDatabase) {
                startDbModalAutoRefresh();
            } else {
                stopDbModalAutoRefresh();
            }
        }

        function startDbModalAutoRefresh() {
            if (dbModalRefreshInterval) clearInterval(dbModalRefreshInterval);
            if (dbModalAutoRefresh && currentModalDatabase) {
                dbModalRefreshInterval = setInterval(() => refreshDatabaseModal(), REFRESH_INTERVAL);
            }
        }

        function stopDbModalAutoRefresh() {
            if (dbModalRefreshInterval) {
                clearInterval(dbModalRefreshInterval);
                dbModalRefreshInterval = null;
            }
        }

        async function refreshDatabaseModal() {
            if (!currentModalDatabase) return;

            const btn = document.getElementById('db-modal-refresh-btn');
            btn.classList.add('spinning');

            await loadDatabaseData(currentModalDatabase);

            btn.classList.remove('spinning');
        }

        function closeDatabaseModal() {
            document.getElementById('database-modal').classList.remove('active');
            stopDbModalAutoRefresh();
            currentModalDatabase = null;
            dbModalAutoRefresh = false;
            // Reset to charts tab
            switchDbModalTab('charts');
        }

        // Database modal tab switching
        function switchDbModalTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('#db-modal-tabs .modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`#db-modal-tabs .modal-tab[onclick*="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('#db-modal-body .modal-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`db-tab-${tabName}`).classList.add('active');

            // Load data for the tab if needed
            if (tabName === 'deps' && currentModalDatabase) {
                loadDatabaseDependencies();
            }
        }

        async function loadDatabaseDependencies() {
            if (!currentModalDatabase) return;

            const depsDiv = document.getElementById('db-dependents');
            depsDiv.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const response = await fetch(`/api/database/${encodeURIComponent(currentModalDatabase)}/dependencies?time=15m`);
                const data = await response.json();

                if (data.dependents && data.dependents.length > 0) {
                    depsDiv.innerHTML = data.dependents.map(dep => `
                        <div class="dep-item" onclick="openServiceModal('${escapeHtml(dep.dependent)}')">
                            <div class="dep-name">
                                <span class="dep-type-badge service">service</span>
                                ${escapeHtml(dep.dependent)}
                            </div>
                            <div style="text-align: right;">
                                <span class="dep-calls">${dep.call_count} calls</span>
                                <span style="margin-left: 8px; color: ${dep.error_pct > 5 ? 'var(--accent-error)' : 'var(--text-muted)'}; font-size: 11px;">${dep.error_pct}% err</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    depsDiv.innerHTML = '<div class="empty-state">No services found using this database</div>';
                }
            } catch (error) {
                console.error('Failed to load database dependencies:', error);
                depsDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
            }
        }

        // Error Modal Functions
        async function openErrorModal(traceId, spanId) {
            document.getElementById('error-modal').classList.add('active');
            document.getElementById('error-modal-title').textContent = 'Loading...';

            try {
                const response = await fetch(`/api/error/${encodeURIComponent(traceId)}/${encodeURIComponent(spanId)}`);
                const data = await response.json();

                if (data.error_info) {
                    const info = data.error_info;
                    document.getElementById('error-modal-title').textContent = info.span_name || 'Error Details';
                    document.getElementById('error-service').textContent = info.service_name || '-';
                    document.getElementById('error-operation').textContent = info.span_name || '-';
                    document.getElementById('error-timestamp').textContent = info.start_time ? new Date(info.start_time).toLocaleString() : '-';
                    document.getElementById('error-duration').textContent = info.duration_ms ? `${info.duration_ms}ms` : '-';
                    document.getElementById('error-trace-id').textContent = traceId;
                }

                // Exception details
                const exceptionCard = document.getElementById('exception-card');
                if (data.exception && data.exception.exception_type) {
                    exceptionCard.style.display = 'block';
                    document.getElementById('exception-type').textContent = data.exception.exception_type || '-';
                    document.getElementById('exception-message').textContent = data.exception.exception_message || '-';
                } else {
                    exceptionCard.style.display = 'none';
                }

                // Full trace
                const traceTable = document.getElementById('trace-table').querySelector('tbody');
                if (data.trace && data.trace.length > 0) {
                    traceTable.innerHTML = data.trace.map(span => `
                        <tr class="${span.status_code === 'ERROR' ? 'error-row' : ''}">
                            <td>${escapeHtml(span.service_name)}</td>
                            <td title="${escapeHtml(span.span_name)}">${escapeHtml(span.span_name.substring(0, 40))}</td>
                            <td>${span.duration_ms}ms</td>
                            <td style="color: ${span.status_code === 'ERROR' ? 'var(--accent-error)' : 'var(--accent-success)'}">${span.status_code || 'OK'}</td>
                        </tr>
                    `).join('');
                } else {
                    traceTable.innerHTML = '<tr><td colspan="4" class="empty-state">No trace data</td></tr>';
                }

            } catch (error) {
                console.error('Failed to load error details:', error);
                document.getElementById('error-modal-title').textContent = 'Error loading details';
            }
        }

        function closeErrorModal() {
            document.getElementById('error-modal').classList.remove('active');
        }

        // Host Modal Functions
        async function openHostModal(hostName) {
            currentModalHost = hostName;
            document.getElementById('host-modal').classList.add('active');
            document.getElementById('host-modal-title').textContent = hostName;

            // Enable auto-refresh by default
            hostModalAutoRefresh = true;
            document.getElementById('host-modal-auto-toggle').classList.add('active');
            const indicator = document.getElementById('host-modal-auto-indicator');
            indicator.classList.add('active');
            indicator.querySelector('span:last-child').textContent = 'Auto-refresh on';

            // Reset to metrics tab
            switchHostModalTab('metrics');
            await loadHostData(hostName);
            startHostModalAutoRefresh();
        }

        async function loadHostData(hostName) {
            try {
                const response = await fetch(`/api/host/${encodeURIComponent(hostName)}/services`);
                const data = await response.json();

                // Update current metrics display
                const metricsDiv = document.getElementById('host-current-metrics');
                if (data.current_metrics) {
                    const m = data.current_metrics;
                    const cpu = m.cpu_pct !== null ? m.cpu_pct : '-';
                    const mem = m.memory_pct !== null ? m.memory_pct : '-';
                    const disk = m.disk_pct !== null ? m.disk_pct : '-';

                    const cpuClass = cpu === '-' ? '' : (cpu > 80 ? 'metric-error' : cpu > 60 ? 'metric-warn' : 'metric-ok');
                    const memClass = mem === '-' ? '' : (mem > 85 ? 'metric-error' : mem > 70 ? 'metric-warn' : 'metric-ok');
                    const diskClass = disk === '-' ? '' : (disk > 90 ? 'metric-error' : disk > 75 ? 'metric-warn' : 'metric-ok');

                    metricsDiv.innerHTML = `
                        <div class="host-metric-card">
                            <div class="value ${cpuClass}">${cpu}%</div>
                            <div class="label">CPU Utilization</div>
                        </div>
                        <div class="host-metric-card">
                            <div class="value ${memClass}">${mem}%</div>
                            <div class="label">Memory Utilization</div>
                        </div>
                        <div class="host-metric-card">
                            <div class="value ${diskClass}">${disk}%</div>
                            <div class="label">Disk Utilization</div>
                        </div>
                    `;
                } else {
                    metricsDiv.innerHTML = '<div class="empty-state">No metrics available</div>';
                }

                // Update host info
                const infoDiv = document.getElementById('host-info');
                if (data.host_info) {
                    const info = data.host_info;
                    infoDiv.innerHTML = `
                        <div class="host-info-row">
                            <span class="host-info-label">Hostname</span>
                            <span class="host-info-value">${escapeHtml(hostName)}</span>
                        </div>
                        <div class="host-info-row">
                            <span class="host-info-label">OS Type</span>
                            <span class="host-info-value">${escapeHtml(info.os_type || 'Unknown')}</span>
                        </div>
                        <div class="host-info-row">
                            <span class="host-info-label">Last Seen</span>
                            <span class="host-info-value">${info.last_seen ? new Date(info.last_seen).toLocaleString() : '-'}</span>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="host-info-row">
                            <span class="host-info-label">Hostname</span>
                            <span class="host-info-value">${escapeHtml(hostName)}</span>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Failed to load host data:', error);
            }
        }

        async function loadHostServices() {
            if (!currentModalHost) return;

            const servicesDiv = document.getElementById('host-services');
            servicesDiv.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const response = await fetch(`/api/host/${encodeURIComponent(currentModalHost)}/services`);
                const data = await response.json();

                if (data.services && data.services.length > 0) {
                    servicesDiv.innerHTML = data.services.map(svc => `
                        <div class="dep-item" onclick="openServiceModal('${escapeHtml(svc.service_name)}')">
                            <div class="dep-name">
                                <span class="dep-type-badge service">service</span>
                                ${escapeHtml(svc.service_name)}
                            </div>
                            <div style="text-align: right;">
                                <span class="dep-calls">${svc.span_count} spans</span>
                                <span style="margin-left: 8px; color: ${svc.error_pct > 5 ? 'var(--accent-error)' : 'var(--text-muted)'}; font-size: 11px;">${svc.error_pct}% err</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    servicesDiv.innerHTML = '<div class="empty-state">No services found on this host</div>';
                }
            } catch (error) {
                console.error('Failed to load host services:', error);
                servicesDiv.innerHTML = '<div class="empty-state">Error loading services</div>';
            }
        }

        function switchHostModalTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('#host-modal-tabs .modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`#host-modal-tabs .modal-tab[onclick*="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('#host-modal-body .modal-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`host-tab-${tabName}`).classList.add('active');

            // Load data for the tab if needed
            if (tabName === 'services' && currentModalHost) {
                loadHostServices();
            }
        }

        function toggleHostModalAutoRefresh() {
            hostModalAutoRefresh = !hostModalAutoRefresh;
            const toggle = document.getElementById('host-modal-auto-toggle');
            const indicator = document.getElementById('host-modal-auto-indicator');

            toggle.classList.toggle('active', hostModalAutoRefresh);
            indicator.classList.toggle('active', hostModalAutoRefresh);
            indicator.querySelector('span:last-child').textContent = hostModalAutoRefresh ? 'Auto-refresh on' : 'Auto-refresh off';

            if (hostModalAutoRefresh && currentModalHost) {
                startHostModalAutoRefresh();
            } else {
                stopHostModalAutoRefresh();
            }
        }

        function startHostModalAutoRefresh() {
            if (hostModalRefreshInterval) clearInterval(hostModalRefreshInterval);
            if (hostModalAutoRefresh && currentModalHost) {
                hostModalRefreshInterval = setInterval(() => refreshHostModal(), REFRESH_INTERVAL);
            }
        }

        function stopHostModalAutoRefresh() {
            if (hostModalRefreshInterval) {
                clearInterval(hostModalRefreshInterval);
                hostModalRefreshInterval = null;
            }
        }

        async function refreshHostModal() {
            if (!currentModalHost) return;

            const btn = document.getElementById('host-modal-refresh-btn');
            btn.classList.add('spinning');

            await loadHostData(currentModalHost);
            // If on services tab, refresh that too
            if (document.getElementById('host-tab-services').classList.contains('active')) {
                await loadHostServices();
            }

            btn.classList.remove('spinning');
        }

        function closeHostModal() {
            document.getElementById('host-modal').classList.remove('active');
            stopHostModalAutoRefresh();
            currentModalHost = null;
            hostModalAutoRefresh = false;
            // Reset to metrics tab
            switchHostModalTab('metrics');
        }

        // Help Modal Functions
        function openHelpModal() {
            document.getElementById('help-modal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('active');
        }

        document.getElementById('service-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('database-modal').addEventListener('click', function(e) {
            if (e.target === this) closeDatabaseModal();
        });

        document.getElementById('error-modal').addEventListener('click', function(e) {
            if (e.target === this) closeErrorModal();
        });

        document.getElementById('host-modal').addEventListener('click', function(e) {
            if (e.target === this) closeHostModal();
        });

        document.getElementById('help-modal').addEventListener('click', function(e) {
            if (e.target === this) closeHelpModal();
        });

        document.getElementById('alert-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAlertModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeDatabaseModal();
                closeErrorModal();
                closeHostModal();
                closeHelpModal();
                closeAlertModal();
            }
        });
    </script>
</body>
</html>
