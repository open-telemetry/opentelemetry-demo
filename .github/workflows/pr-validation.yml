name: PR Validation

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  check-test-manifests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for TEST manifest files
        id: check_files
        run: |
          echo "Checking for TEST Splunk manifest files in PR (kubernetes/TEST-splunk*.yaml)..."

          # Get the base branch
          BASE_SHA=$(git merge-base origin/${{ github.base_ref }} HEAD)

          # Check if any TEST Splunk manifest files exist in the PR diff
          if git diff --name-only $BASE_SHA HEAD | grep -E '^kubernetes/TEST-splunk.*\.yaml$'; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            git diff --name-only $BASE_SHA HEAD | grep -E '^kubernetes/TEST-splunk.*\.yaml$' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if TEST files found
        if: steps.check_files.outputs.found == 'true'
        run: |
          echo "❌ ERROR: TEST Splunk manifest files detected in this PR"
          echo ""
          echo "The following TEST Splunk manifest files were found:"
          echo "${{ steps.check_files.outputs.files }}"
          echo ""
          echo "TEST Splunk manifests should not be merged to the main branch."
          echo ""
          echo "To remove these files, run the 'Remove TEST Manifests' workflow:"
          echo "  1. Go to: Actions → Remove TEST Manifests"
          echo "  2. Click 'Run workflow'"
          echo "  3. Select your branch: ${{ github.head_ref }}"
          echo "  4. Type 'CONFIRM' in the confirmation field"
          echo "  5. Click 'Run workflow'"
          echo ""
          echo "Or manually remove them with:"
          echo "  git rm kubernetes/TEST-splunk*.yaml"
          echo "  git commit -m 'chore: remove TEST Splunk manifests'"
          echo "  git push"
          exit 1

      - name: Success
        if: steps.check_files.outputs.found == 'false'
        run: |
          echo "✓ No TEST Splunk manifest files found in this PR"
          echo "### ✓ PR Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No TEST Splunk manifest files detected." >> $GITHUB_STEP_SUMMARY

      - name: Add PR comment if TEST files found
        if: steps.check_files.outputs.found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.check_files.outputs.files }}`.split('\n').filter(f => f);
            const fileList = files.map(f => `- \`${f}\``).join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ TEST Splunk Manifest Files Detected

This PR contains TEST Splunk manifest files that should not be merged to main:

${fileList}

### How to fix this:

**Option 1: Use the automated workflow**
1. Go to [Actions → Remove TEST Manifests](../actions/workflows/remove-test-manifests.yml)
2. Click "Run workflow"
3. Select branch: \`${context.payload.pull_request.head.ref}\`
4. Type \`CONFIRM\` in the confirmation field
5. Click "Run workflow"

**Option 2: Remove manually**
\`\`\`bash
git rm kubernetes/TEST-splunk*.yaml
git commit -m "chore: remove TEST Splunk manifests"
git push
\`\`\`

The PR validation will automatically re-run once the files are removed.`
            });
