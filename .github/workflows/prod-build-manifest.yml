name: Build Demo Manifest - PRODUCTION
# NOTE: Repository check happens at job level (line 29), not at workflow level
# GitHub Actions shows workflow inputs before job conditions are evaluated
# This workflow is designed for splunk/opentelemetry-demo repository only

"on":
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - none (keep current)
          - patch
          - minor
          - major
        default: 'none (keep current)'
      validate_manifest:
        description: 'Validate resulting YAML'
        required: true
        type: boolean
        default: true
      commit_manifest:
        description: 'Commit the generated manifest and version to repository'
        required: true
        type: boolean
        default: true
  workflow_call:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        type: string
        default: 'none (keep current)'
      validate_manifest:
        description: 'Validate resulting YAML'
        required: false
        type: boolean
        default: true
      commit_manifest:
        description: 'Commit the generated manifest and version to repository'
        required: false
        type: boolean
        default: true

jobs:
  build-production-manifest:
    # Only run in the main splunk/opentelemetry-demo repo, not in forks
    # TEMPORARY: Commented out for testing in fork - UNCOMMENT BEFORE PR TO PROD
    if: github.repository == 'splunk/opentelemetry-demo'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/stitch-manifests.sh
          chmod +x .github/scripts/manage-hotfix.py
          chmod +x .github/scripts/bump-version.py
          chmod +x .github/scripts/show-image-versions.py

      - name: Ensure single-version mode (remove per-service test versions)
        run: |
          # Production builds use SPLUNK-VERSION for all services
          # Remove .service-versions.yaml (test-only) if it exists
          if [ -f ".service-versions.yaml" ]; then
            echo "Removing .service-versions.yaml (test/dev only)"
            rm .service-versions.yaml
          fi
          # Keep .hotfix.yaml if it exists (production hotfixes)

      - name: Determine and bump version
        id: version
        run: |
          # Production uses SPLUNK-VERSION as base
          # Hotfixes are tracked separately in .hotfix.yaml

          CURRENT_VERSION=$(cat SPLUNK-VERSION)
          BUMP_TYPE="${{ inputs.version_bump }}"

          # Bump version if requested
          if [[ "$BUMP_TYPE" != "none (keep current)" ]]; then
            NEW_VERSION=$(python3 .github/scripts/bump-version.py "$CURRENT_VERSION" "$BUMP_TYPE")
            echo "$NEW_VERSION" > SPLUNK-VERSION
            echo "âœ… SPLUNK-VERSION bumped: $CURRENT_VERSION â†’ $NEW_VERSION"
            VERSION_BUMPED="true"
          else
            NEW_VERSION="$CURRENT_VERSION"
            echo "Using current version: $CURRENT_VERSION"
            VERSION_BUMPED="false"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "version_bumped=$VERSION_BUMPED" >> $GITHUB_OUTPUT

          echo "### ðŸ“‹ Manifest Version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$VERSION_BUMPED" == "true" ]]; then
            echo "| Type | Version |" >> $GITHUB_STEP_SUMMARY
            echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
            echo "| Previous | \`$CURRENT_VERSION\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **New** | **\`$NEW_VERSION\`** |" >> $GITHUB_STEP_SUMMARY
            echo "| Bump Type | $BUMP_TYPE |" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Version:** \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for active hotfixes
          if [ -f ".hotfix.yaml" ]; then
            echo "#### ðŸ”§ Active Hotfixes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            python3 .github/scripts/manage-hotfix.py status >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> Manifest will include hotfixed service versions" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Build/Stitch Kubernetes manifest
        id: stitch
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stitching Manifest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run stitch script with prod registry
          .github/scripts/stitch-manifests.sh prod

          MANIFEST_FILE="kubernetes/splunk-astronomy-shop-${{ steps.version.outputs.new_version }}.yaml"

          if [ -f "$MANIFEST_FILE" ]; then
            FILE_SIZE=$(du -h "$MANIFEST_FILE" | cut -f1)
            LINE_COUNT=$(wc -l < "$MANIFEST_FILE")
            RESOURCE_COUNT=$(grep -c "^kind: " "$MANIFEST_FILE" || true)
            NAMESPACE_COUNT=$(grep -c "namespace: astronomy-shop" "$MANIFEST_FILE" || true)

            echo "âœ… **Manifest created successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| File | \`$MANIFEST_FILE\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Size | $FILE_SIZE |" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | $LINE_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Resources | $RESOURCE_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Namespaced | $NAMESPACE_COUNT |" >> $GITHUB_STEP_SUMMARY
            echo "| Registry | Production (ghcr.io/splunk/opentelemetry-demo) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "manifest_file=$MANIFEST_FILE" >> $GITHUB_OUTPUT
          else
            echo "âŒ **Manifest file not created**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Validate manifest YAML syntax
        if: ${{ inputs.validate_manifest }}
        run: |
          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          MANIFEST_FILE="${{ steps.stitch.outputs.manifest_file }}"

          # Validate YAML syntax with Python
          if python3 -c "import yaml; list(yaml.safe_load_all(open('$MANIFEST_FILE')))" 2> /tmp/validation.log; then
            echo "âœ… **YAML syntax validation passed**" >> $GITHUB_STEP_SUMMARY

            # Count documents
            DOC_COUNT=$(python3 -c "import yaml; print(len(list(yaml.safe_load_all(open('$MANIFEST_FILE')))))")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **YAML Documents:** $DOC_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **YAML syntax validation failed**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/validation.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Show resource breakdown
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Types:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep "^kind: " "$MANIFEST_FILE" | sort | uniq -c | sort -rn >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Show image version breakdown in manifest
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Image Versions in Manifest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This manifest includes the following service image versions:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show version breakdown
          python3 .github/scripts/show-image-versions.py \
            --base-version "${{ steps.version.outputs.new_version }}" \
            --format github >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show summary
          echo "**Summary:**" >> $GITHUB_STEP_SUMMARY
          python3 .github/scripts/show-image-versions.py \
            --base-version "${{ steps.version.outputs.new_version }}" \
            --summary-only >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request with manifest changes
        if: ${{ inputs.commit_manifest }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          VERSION="${{ steps.version.outputs.new_version }}"
          OLD_VERSION="${{ steps.version.outputs.old_version }}"
          VERSION_BUMPED="${{ steps.version.outputs.version_bumped }}"
          MANIFEST_FILE="${{ steps.stitch.outputs.manifest_file }}"
          BUMP_TYPE="${{ inputs.version_bump }}"
          BRANCH_NAME="release/manifest-${VERSION}"

          # Add version file if it was bumped
          if [[ "$VERSION_BUMPED" == "true" ]]; then
            git add SPLUNK-VERSION
          fi

          # Always add manifest file
          git add "$MANIFEST_FILE"

          if git diff --staged --quiet; then
            echo "### No Changes" >> $GITHUB_STEP_SUMMARY
            echo "No changes to commit." >> $GITHUB_STEP_SUMMARY
          else
            # Create and checkout new branch
            git checkout -b "$BRANCH_NAME"

            # Set commit message based on whether version changed
            if [[ "$VERSION_BUMPED" == "true" ]]; then
              COMMIT_TITLE="Release: ${VERSION}"
              PR_TITLE="Release ${VERSION}: Production Manifest"

              git commit -m "$COMMIT_TITLE" \
                -m "Production manifest with version bump" \
                -m "" \
                -m "- Version: ${OLD_VERSION} â†’ ${VERSION}" \
                -m "- Bump Type: ${{ inputs.version_bump }}" \
                -m "- Manifest: $MANIFEST_FILE" \
                -m "- Registry: ghcr.io/splunk/opentelemetry-demo (production)" \
                -m "" \
                -m "Updated:" \
                -m "- SPLUNK-VERSION" \
                -m "- Stitched manifest"
            else
              COMMIT_TITLE="Update manifest: ${VERSION}"
              PR_TITLE="Update Production Manifest: ${VERSION}"

              git commit -m "$COMMIT_TITLE" \
                -m "Production manifest (no version change)" \
                -m "" \
                -m "- Version: ${VERSION}" \
                -m "- Manifest: $MANIFEST_FILE" \
                -m "- Registry: ghcr.io/splunk/opentelemetry-demo (production)" \
                -m "" \
                -m "Updated:" \
                -m "- Stitched manifest"
            fi

            # Delete remote branch if it exists (from previous failed runs)
            git push origin --delete "$BRANCH_NAME" 2>/dev/null || true

            # Push branch
            git push -u origin "$BRANCH_NAME"

            # Create pull request body with variable expansion using printf to avoid YAML parsing issues
            if [[ "$VERSION_BUMPED" == "true" ]]; then
              PR_BODY=$(printf '%s\n' \
                "## Production Manifest Release ${VERSION}" \
                "" \
                "**Version Bump:** ${OLD_VERSION} â†’ ${VERSION} (${{ inputs.version_bump }})" \
                "**Registry:** Production (\`ghcr.io/splunk/opentelemetry-demo\`)" \
                "" \
                "### Changes" \
                "- âœ… SPLUNK-VERSION updated to \`${VERSION}\`" \
                "- âœ… Manifest: \`${MANIFEST_FILE}\`" \
                "" \
                "### Manifest Contents" \
                "This manifest combines all service deployments. It may contain mixed image versions:" \
                "- Services built at \`${VERSION}\`" \
                "- Services at older versions" \
                "- Hotfixed services with custom versions" \
                "" \
                "See the **Image Versions in Manifest** section in the workflow summary for details." \
                "" \
                "---" \
                "ðŸ¤– Generated automatically by GitHub Actions"
              )
            else
              PR_BODY=$(printf '%s\n' \
                "## Production Manifest Update" \
                "" \
                "**Version:** \`${VERSION}\` (unchanged)" \
                "**Registry:** Production (\`ghcr.io/splunk/opentelemetry-demo\`)" \
                "" \
                "### Changes" \
                "- âœ… Manifest updated: \`${MANIFEST_FILE}\`" \
                "" \
                "### Manifest Contents" \
                "This manifest combines all service deployments with their current image versions." \
                "" \
                "See the **Image Versions in Manifest** section in the workflow summary for details." \
                "" \
                "---" \
                "ðŸ¤– Generated automatically by GitHub Actions"
              )
            fi

            gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME"

            PR_URL=$(gh pr view "$BRANCH_NAME" --json url -q .url)

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Pull Request Created âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PR:** [$PR_TITLE]($PR_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changes:**" >> $GITHUB_STEP_SUMMARY
            if [[ "$VERSION_BUMPED" == "true" ]]; then
              echo "- âœ… SPLUNK-VERSION: ${OLD_VERSION} â†’ \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- âœ… Manifest: \`$MANIFEST_FILE\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ‘‰ **Review and merge the PR to deploy**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload manifest as artifact
        uses: actions/upload-artifact@v4
        with:
          name: astronomy-shop-manifest-${{ steps.version.outputs.new_version }}
          path: kubernetes/splunk-astronomy-shop-${{ steps.version.outputs.new_version }}.yaml
          retention-days: 90

      - name: Generate deployment command
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Deploy to Production Cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Option 1: Deploy from Repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest changes" >> $GITHUB_STEP_SUMMARY
          echo "git pull" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Deploy to cluster" >> $GITHUB_STEP_SUMMARY
          echo "kubectl apply -f kubernetes/splunk-astronomy-shop-${{ steps.version.outputs.new_version }}.yaml" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify deployment" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get all -n astronomy-shop" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Option 2: Download Artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download artifact: \`astronomy-shop-manifest-${{ steps.version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the YAML file" >> $GITHUB_STEP_SUMMARY
          echo "3. Deploy: \`kubectl apply -f splunk-astronomy-shop-${{ steps.version.outputs.new_version }}.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Monitor Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Watch pods come up" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n astronomy-shop -w" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check pod status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n astronomy-shop" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# View logs for a service" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n astronomy-shop deployment/<service-name>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check services" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get svc -n astronomy-shop" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ Production Manifest Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY

          VERSION_BUMPED="${{ steps.version.outputs.version_bumped }}"
          if [[ "$VERSION_BUMPED" == "true" ]]; then
            echo "| **Previous Version** | \`${{ steps.version.outputs.old_version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **New Version** | **\`${{ steps.version.outputs.new_version }}\`** |" >> $GITHUB_STEP_SUMMARY
            echo "| **Bump Type** | ${{ inputs.version_bump }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Version** | \`${{ steps.version.outputs.new_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| **Manifest File** | \`kubernetes/splunk-astronomy-shop-${{ steps.version.outputs.new_version }}.yaml\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Registry** | Production (ghcr.io/splunk/opentelemetry-demo) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Validated** | ${{ inputs.validate_manifest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Committed** | ${{ inputs.commit_manifest }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Artifact Retention** | 90 days |" >> $GITHUB_STEP_SUMMARY
