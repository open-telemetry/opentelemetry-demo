# Default values for opentelemetry-demo.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Namespace to deploy the demo into
namespace: otel-demo

# =============================================================================
# Azure Data Explorer Configuration
# =============================================================================
# Set these values to enable ADX as the telemetry backend
adx:
  enabled: true
  # ADX cluster URI (e.g., https://mycluster.eastus.kusto.windows.net)
  clusterUri: ""
  # ADX database name
  database: "otel_demo"
  # Table names for telemetry data
  tables:
    traces: "OTelTraces"
    metrics: "OTelMetrics"
    logs: "OTelLogs"
  # Ingestion mappings (must match ADX schema)
  mappings:
    traces: "otel_traces_mapping"
    metrics: "otel_metrics_mapping"
    logs: "otel_logs_mapping"
  # Ingestion type: "managed" (low latency) or "queued" (high throughput)
  ingestionType: "managed"

# =============================================================================
# Azure Authentication
# =============================================================================
# Two authentication methods are supported:
#
# 1. Workload Identity (RECOMMENDED - no secrets needed!)
#    Set azure.workloadIdentity.enabled=true and provide clientId
#
# 2. Service Principal (legacy - requires client secret)
#    Set azure.clientSecret or azure.existingSecret
#
azure:
  tenantId: ""

  # --------------------------------------------------------------------------
  # Option 1: Workload Identity (Recommended)
  # --------------------------------------------------------------------------
  # Uses Azure AD Workload Identity for secure, secret-less authentication
  # Requires: AKS with OIDC issuer enabled + Federated Identity Credential
  workloadIdentity:
    enabled: false
    # Client ID of the User-Assigned Managed Identity
    clientId: ""

  # --------------------------------------------------------------------------
  # Option 2: Service Principal (Legacy)
  # --------------------------------------------------------------------------
  # Uses client ID + client secret stored in Kubernetes Secret
  clientId: ""
  clientSecret: ""
  # Use existing secret instead of creating one from values above
  existingSecret: ""

# Global labels applied to all resources
global:
  labels:
    app.kubernetes.io/version: "2.1.3"
    app.kubernetes.io/part-of: opentelemetry-demo

# Grafana configuration
grafana:
  enabled: true
  adminUser: admin
  adminPassword: admin
  plugins: grafana-azure-data-explorer-datasource

  # -------------------------------------------------------------------------
  # Alerting Configuration
  # -------------------------------------------------------------------------
  # Pre-configured alert rules for ADX observability
  # Users can add additional contact points via Grafana UI
  alerting:
    enabled: true

    # Alert thresholds (customize based on your SLOs)
    thresholds:
      # Trigger alert when error rate exceeds this percentage
      errorRatePercent: 5
      # Trigger alert when P95 latency exceeds this value (milliseconds)
      p95LatencyMs: 500
      # Trigger alert when error log count exceeds this in 5 minutes
      errorLogsCount: 10

    # -----------------------------------------------------------------------
    # Email Notifications (SMTP)
    # -----------------------------------------------------------------------
    # Configure SMTP to enable email alerts
    # Supports: SendGrid, Azure Communication Services, Gmail, etc.
    smtp:
      enabled: false
      host: ""           # e.g., smtp.sendgrid.net
      port: 587
      user: ""           # e.g., apikey (for SendGrid)
      password: ""       # e.g., your SendGrid API key
      fromAddress: ""    # e.g., alerts@yourdomain.com
      fromName: "Grafana Alerts"
      toAddresses: ""    # Comma-separated list of recipient emails
      # Skip TLS verification (not recommended for production)
      skipVerify: false

    # -----------------------------------------------------------------------
    # Slack Notifications
    # -----------------------------------------------------------------------
    # Get webhook URL from: Slack > Apps > Incoming Webhooks
    slack:
      enabled: false
      webhookUrl: ""     # e.g., https://hooks.slack.com/services/xxx/yyy/zzz
      channel: ""        # Optional: override default channel

    # -----------------------------------------------------------------------
    # Microsoft Teams Notifications
    # -----------------------------------------------------------------------
    # Get webhook URL from: Teams > Channel > Connectors > Incoming Webhook
    teams:
      enabled: false
      webhookUrl: ""     # e.g., https://outlook.office.com/webhook/xxx

# OpenTelemetry Collector configuration
otelCollector:
  enabled: true
  version: "0.135.0"

  # Service account configuration
  serviceAccount:
    name: "otel-collector-sa"
    # Annotations are auto-set when workloadIdentity.enabled=true

  # Health check endpoint
  healthCheck:
    enabled: true
    port: 13133

  # Processors configuration
  processors:
    memoryLimiter:
      checkInterval: 5s
      limitPercentage: 80
      spikeLimitPercentage: 25

  # Queue settings for ADX exporter
  queue:
    enabled: true
    numConsumers: 10
    queueSize: 5000

  # Retry settings for ADX exporter
  retry:
    enabled: true
    initialInterval: 5s
    maxInterval: 30s
    maxElapsedTime: 300s

# Feature flags configuration
featureFlags:
  productCatalogFailure: "off"
  recommendationCacheFailure: "off"
  adManualGc: "off"
  adHighCpu: "off"
  adFailure: "off"
  kafkaQueueProblems: "off"
  cartFailure: "off"
  paymentFailure: "off"
  paymentUnreachable: "off"
  loadGeneratorFloodHomepage: "off"
  imageSlowLoad: "off"

# Service account configuration
serviceAccount:
  create: true
  name: opentelemetry-demo
  automountServiceAccountToken: false
