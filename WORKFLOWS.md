# Manifest Build Workflows

This project has two workflows for building Kubernetes manifests: one for testing (dev) and one for production.

## Overview

| Feature | Test Workflow | Production Workflow |
|---------|--------------|---------------------|
| **File** | `.github/workflows/test-build-manifest.yml` | `.github/workflows/prod-build-manifest.yml` |
| **Name** | Build Demo Manifest - TEST | Build Demo Manifest - PRODUCTION |
| **Repository** | Only runs in **forks** | Only runs in **splunk/opentelemetry-demo** |
| **Registry** | Dev (`ghcr.io/hagen-p/opentelemetry-demo-splunk`) | Prod (`ghcr.io/splunk/opentelemetry-demo`) |
| **Versioning** | Test suffix (e.g., `0.0.0-test`) | Version bump (patch/minor/major) |
| **Commits** | Optional (default: no) | Optional (default: yes) |
| **Artifact Retention** | 7 days | 90 days |

---

## Test Workflow (Development/Forks)

### When to Use
- Testing manifest generation in your fork
- Validating changes before submitting PRs
- Development and experimentation

### Configuration
```yaml
on: workflow_dispatch
  inputs:
    test_version_suffix: '-test'  # Suffix added to version
    commit_manifest: false         # Don't commit by default
    validate_manifest: true        # Validate YAML
```

### Usage
1. Go to: `https://github.com/YOUR-USERNAME/opentelemetry-demo-splunk/actions`
2. Select: **"Build Demo Manifest - TEST"**
3. Click: **"Run workflow"**
4. Configure:
   - **test_version_suffix**: `-test` (or custom suffix)
   - **commit_manifest**: ‚òê Unchecked (usually)
   - **validate_manifest**: ‚òë Checked

### Output
- **File**: `kubernetes/splunk-astronomy-shop-{version}-test.yaml`
- **Registry**: All images use dev registry
- **Artifact**: Available for download (7 days)
- **Version file**: NOT modified

### Example
Current version: `0.0.0`
Generated manifest: `kubernetes/splunk-astronomy-shop-0.0.0-test.yaml`
Registry: `ghcr.io/hagen-p/opentelemetry-demo-splunk:2.1.3`

---

## Production Workflow (Main Repository)

### When to Use
- Creating official releases
- Deploying to production
- Publishing versioned manifests

### Configuration
```yaml
on: workflow_dispatch
  inputs:
    version_bump: minor           # patch/minor/major
    commit_manifest: true         # Commit by default
    validate_manifest: true       # Validate YAML
```

### Usage
1. Go to: `https://github.com/splunk/opentelemetry-demo/actions`
2. Select: **"Build Demo Manifest - PRODUCTION"**
3. Click: **"Run workflow"**
4. Configure:
   - **version_bump**: Choose patch/minor/major
   - **commit_manifest**: ‚òë Checked (usually)
   - **validate_manifest**: ‚òë Checked

### Version Bumping

| Bump Type | Description | Example |
|-----------|-------------|---------|
| **patch** | Bug fixes, minor updates | `0.0.0` ‚Üí `0.0.1` |
| **minor** | New features, backwards compatible | `0.0.0` ‚Üí `0.1.0` |
| **major** | Breaking changes | `0.0.0` ‚Üí `1.0.0` |

### Output
- **File**: `kubernetes/splunk-astronomy-shop-{version}.yaml`
- **Registry**: All images use prod registry
- **Artifact**: Available for download (90 days)
- **Version file**: SPLUNK-VERSION updated and committed
- **Git commit**: Created with release information

### Example
Current version: `0.0.0`
Bump: `minor`
New version: `0.1.0`
Generated manifest: `kubernetes/splunk-astronomy-shop-0.1.0.yaml`
Registry: `ghcr.io/splunk/opentelemetry-demo:2.1.3`

---

## Registry Configuration

Both workflows use the registry configuration from `services.yaml`:

```yaml
registry:
  prod: "ghcr.io/splunk/opentelemetry-demo"
  dev: "ghcr.io/hagen-p/opentelemetry-demo-splunk"
```

Services can opt out of registry replacement:
```yaml
services:
  - name: astronomy-loadgen
    replace_registry: false  # Keep original registry
```

See `REGISTRY-CONFIG.md` for more details.

---

## Workflow Outputs

### GitHub Actions Summary
Both workflows provide detailed summaries:
- Version information
- Manifest statistics (size, resources, lines)
- Validation results
- Deployment commands
- Resource breakdown

### Artifacts
- Downloadable ZIP with the generated manifest
- Test: 7-day retention
- Production: 90-day retention

### Git Commits (if enabled)
Production workflow creates commits like:
```
Release: 0.1.0

Production build of Astronomy Shop manifest

- Version: 0.1.0
- Previous: 0.0.0
- Bump Type: minor
- Manifest: kubernetes/splunk-astronomy-shop-0.1.0.yaml
- Registry: ghcr.io/splunk/opentelemetry-demo (production)
- Generated by: GitHub Actions (production build)

ü§ñ Generated with Claude Code
```

---

## Security & Access Control

### Test Workflow
- **Blocked in**: `splunk/opentelemetry-demo`
- **Allowed in**: All forks
- **Check**: `if: github.repository != 'splunk/opentelemetry-demo'`

### Production Workflow
- **Allowed in**: `splunk/opentelemetry-demo` ONLY
- **Blocked in**: All forks
- **Check**: `if: github.repository == 'splunk/opentelemetry-demo'`

This prevents:
- Accidental production releases from forks
- Test artifacts appearing in the main repository

---

## Common Scenarios

### Scenario 1: Testing Changes in Fork
1. Make changes to service manifests
2. Run **TEST workflow** with `commit_manifest: false`
3. Download artifact and test locally
4. Submit PR to main repository

### Scenario 2: Creating a Patch Release
1. In main repo, run **PRODUCTION workflow**
2. Select `version_bump: patch`
3. Enable `commit_manifest: true`
4. Manifest and version are committed automatically

### Scenario 3: Major Release
1. In main repo, run **PRODUCTION workflow**
2. Select `version_bump: major`
3. Enable `commit_manifest: true`
4. Review commit before deploying

### Scenario 4: Testing Without Commit
1. Run **TEST workflow** (forks) or **PRODUCTION workflow** (main)
2. Disable `commit_manifest`
3. Download artifact to review
4. Re-run with commit enabled if satisfied

---

## Troubleshooting

### Workflow Doesn't Appear
- **Test workflow**: Make sure you're in a fork, not `splunk/opentelemetry-demo`
- **Production workflow**: Make sure you're in `splunk/opentelemetry-demo`, not a fork

### YAML Validation Failed
- Check service manifests for syntax errors
- Ensure all `---` separators are on their own line
- Run locally: `python3 -c "import yaml; yaml.safe_load_all(open('file.yaml'))"`

### Registry Not Replaced
- Check `services.yaml` has correct registry URLs
- Check service doesn't have `replace_registry: false`
- Verify workflow uses correct parameter (`dev` or `prod`)

### Version Not Bumped
- Only production workflow bumps version
- Test workflow uses suffix instead
- Check `SPLUNK-VERSION` file exists

---

## Related Documentation

- `REGISTRY-CONFIG.md` - Registry configuration details
- `services.yaml` - Service and registry configuration
- `.github/scripts/stitch-manifests.sh` - Manifest generation script
- `.github/scripts/bump-version.sh` - Version bumping script
