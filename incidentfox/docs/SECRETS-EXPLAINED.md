# Secrets Management - What Gets Stored Where

## Quick Answer

**NO secrets are tracked in Git or in `terraform.tfvars`!**

All sensitive passwords are:
1. **Generated randomly** by Terraform at deployment time
2. **Stored in AWS Secrets Manager** (encrypted)
3. **Also in Terraform state** (should be remote + encrypted)
4. **Never in Git, never committed**

## Current Secrets in the System

### 1. PostgreSQL Database Credentials

**What:** Database username and password for the demo's PostgreSQL instance

**Generated by:**
```hcl
# terraform/main.tf
resource "random_password" "postgres" {
  length  = 32
  special = true
}

module "secrets" {
  secrets = {
    postgres = {
      secret_data = {
        username = "otelu"              # Fixed username
        password = random_password.postgres.result  # RANDOM 32-char password
      }
    }
  }
}
```

**Stored in:**
- AWS Secrets Manager: `incidentfox-demo/postgres`
- Terraform state: `terraform.tfstate` (encrypted if using S3 backend)
- Kubernetes: `postgres-credentials` secret (synced by External Secrets Operator)

**Used by:**
- PostgreSQL pods
- Accounting service (connects to PostgreSQL)
- Product Reviews service (connects to PostgreSQL)

**NOT stored in:**
- ❌ Git
- ❌ `terraform.tfvars`
- ❌ Any config files
- ❌ Environment variables (except in pods)

---

### 2. Grafana Admin Credentials

**What:** Admin username and password for Grafana dashboards

**Generated by:**
```hcl
# terraform/main.tf
resource "random_password" "grafana" {
  length  = 32
  special = false  # No special chars for easier web login
}

module "secrets" {
  secrets = {
    grafana = {
      secret_data = {
        admin-user     = "admin"           # Fixed username
        admin-password = random_password.grafana.result  # RANDOM 32-char password
      }
    }
  }
}
```

**Stored in:**
- AWS Secrets Manager: `incidentfox-demo/grafana`
- Terraform state: `terraform.tfstate`
- Kubernetes: `grafana-credentials` secret (synced by External Secrets Operator)

**Used by:**
- Grafana pods (admin login)

**NOT stored in:**
- ❌ Git
- ❌ `terraform.tfvars`
- ❌ Any config files

---

## What IS in terraform.tfvars?

**Only non-sensitive configuration:**

```hcl
# terraform.tfvars - SAFE to customize, NO SECRETS HERE
region      = "us-west-2"
cluster_name = "incidentfox-demo"
environment = "lab"

# Node configuration
app_node_instance_type = "t3.large"
app_node_desired_size  = 3

# Tags
tags = {
  Project = "incidentfox"
  Owner   = "sre-team"
}
```

**This file should NOT be committed if you customize it with your AWS account details, but it contains NO passwords or secrets.**

---

## Security Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                   NEVER IN GIT                               │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │   Terraform Execution (local or CI/CD)                 │ │
│  │                                                          │ │
│  │   random_password.postgres.result = "xK9mP2...vQ8"     │ │
│  │   random_password.grafana.result  = "Bv3nL7...mR4"     │ │
│  └────────────────────────────────────────────────────────┘ │
│                           ↓                                  │
│                    (Terraform stores)                        │
│                           ↓                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │   AWS Secrets Manager (encrypted)                      │ │
│  │                                                          │ │
│  │   incidentfox-demo/postgres:                           │ │
│  │     {username: "otelu", password: "xK9mP2...vQ8"}      │ │
│  │                                                          │ │
│  │   incidentfox-demo/grafana:                            │ │
│  │     {admin-user: "admin", admin-password: "Bv3nL7..."}│ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │   Terraform State (should be encrypted S3 backend)     │ │
│  │                                                          │ │
│  │   Contains the random_password results                 │ │
│  │   ⚠️  This is why Terraform state must be secure!      │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                           ↓
            (External Secrets Operator syncs)
                           ↓
┌─────────────────────────────────────────────────────────────┐
│              Kubernetes Cluster                              │
│                                                              │
│  kubernetes.io/secret/postgres-credentials                  │
│  kubernetes.io/secret/grafana-credentials                   │
│                                                              │
│  (Pods read these secrets via environment variables)        │
└─────────────────────────────────────────────────────────────┘
```

---

## How to Retrieve Secrets

### Option 1: From AWS Secrets Manager

```bash
# PostgreSQL password
aws secretsmanager get-secret-value \
  --secret-id incidentfox-demo/postgres \
  --query SecretString --output text | jq -r .password

# Grafana password
aws secretsmanager get-secret-value \
  --secret-id incidentfox-demo/grafana \
  --query SecretString --output text | jq -r '."admin-password"'
```

### Option 2: From Kubernetes (if cluster is running)

```bash
# PostgreSQL password
kubectl get secret postgres-credentials -n otel-demo \
  -o jsonpath='{.data.password}' | base64 -d

# Grafana password
kubectl get secret grafana-credentials -n otel-demo \
  -o jsonpath='{.data.admin-password}' | base64 -d
```

### Option 3: From Terraform State (not recommended)

```bash
cd incidentfox/terraform
terraform output -json | jq -r '.secrets.value'
# This is marked as sensitive, so won't show by default
```

---

## Backing Up to 1Password

Use the provided script:

```bash
# Export secrets to 1Password CLI format
./scripts/export-secrets-to-1password.sh

# Or manually:
aws secretsmanager get-secret-value \
  --secret-id incidentfox-demo/postgres \
  --query SecretString --output text > /tmp/postgres-secret.json

# Then import to 1Password via UI or CLI
```

**See:** `scripts/export-secrets-to-1password.sh` for automated backup.

---

## Important Security Notes

### ✅ GOOD Practices (We Follow)

1. **Secrets generated at runtime** - Never hardcoded
2. **Random passwords** - 32 characters, cryptographically secure
3. **Stored in AWS Secrets Manager** - Encrypted at rest
4. **IRSA for access** - No long-lived credentials
5. **Auto-sync to Kubernetes** - External Secrets Operator
6. **Not in Git** - `.gitignore` includes `terraform.tfvars` and `*.tfstate`

### ⚠️ Critical Security Requirements

1. **Terraform State Must Be Encrypted**
   ```hcl
   # Add to terraform/main.tf
   backend "s3" {
     bucket         = "your-terraform-state"
     key            = "incidentfox/terraform.tfstate"
     region         = "us-west-2"
     encrypt        = true
     dynamodb_table = "terraform-state-lock"
   }
   ```

2. **Never Commit terraform.tfstate**
   - Already in `.gitignore`
   - Use remote backend (S3)
   - Enable versioning and encryption

3. **Restrict AWS Secrets Manager Access**
   - Only External Secrets Operator can read
   - Use IAM policies (already configured)
   - Enable CloudTrail logging

4. **Backup Secrets to 1Password**
   - Run export script after deployment
   - Store in secure 1Password vault
   - Share with team securely

---

## .gitignore Configuration

Verify these are in `.gitignore`:

```gitignore
# Terraform
**/.terraform/*
*.tfstate
*.tfstate.*
*.tfvars
!terraform.tfvars.example

# Secrets
**/secrets.yaml
**/credentials.json
**/*-secret.json
**/.env.local

# AWS
.aws/
*.pem
*.key
```

---

## FAQs

### Q: Where do I put my AWS credentials?

**A:** In `~/.aws/credentials`, NOT in the repo:

```ini
[incidentfox]
aws_access_key_id = YOUR_KEY
aws_secret_access_key = YOUR_SECRET
```

Then use: `export AWS_PROFILE=incidentfox`

### Q: Can I use my own passwords instead of random ones?

**A:** Not recommended, but if you must:

```hcl
# terraform/main.tf - NOT RECOMMENDED
resource "random_password" "postgres" {
  length  = 32
  special = true
  override_special = "your-chosen-password"  # Don't do this
}
```

Better: Let Terraform generate them, then back up to 1Password.

### Q: What if I lose the passwords?

**A:** They're in AWS Secrets Manager. Retrieve them:

```bash
aws secretsmanager get-secret-value --secret-id incidentfox-demo/postgres
```

### Q: How do I rotate passwords?

**A:** Update in AWS Secrets Manager:

```bash
aws secretsmanager update-secret \
  --secret-id incidentfox-demo/postgres \
  --secret-string '{"username":"otelu","password":"NEW_PASSWORD"}'
```

External Secrets Operator will sync within 1 hour. Or force immediate sync:

```bash
kubectl annotate externalsecret postgres-credentials -n otel-demo \
  force-sync=$(date +%s) --overwrite
```

---

## Summary

**Current Secrets:**
1. PostgreSQL: `incidentfox-demo/postgres` (username + password)
2. Grafana: `incidentfox-demo/grafana` (admin-user + admin-password)

**Where They Are:**
- ✅ AWS Secrets Manager (primary storage)
- ✅ Terraform state (should be remote + encrypted)
- ✅ Kubernetes secrets (synced by ESO)
- ❌ NEVER in Git
- ❌ NEVER in terraform.tfvars

**How to Back Up:**
- Use the export script: `./scripts/export-secrets-to-1password.sh`
- Store in 1Password vault
- Share securely with team

**Security is Solid:**
- Random generation ✅
- Encrypted storage ✅
- No Git commits ✅
- IRSA authentication ✅
- Audit logging ready ✅

