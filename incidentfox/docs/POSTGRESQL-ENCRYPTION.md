# PostgreSQL Encryption Guide

## Current Status

**PostgreSQL runs as a Kubernetes pod** (not directly on EC2). Here's what encryption means for PostgreSQL:

## Three Layers of PostgreSQL Encryption

### 1. âœ… Storage Encryption (Already Done!)

**What:** The EBS volume where PostgreSQL data is stored

**Status:** âœ… **ALREADY ENCRYPTED**

**How it works:**
```
PostgreSQL Pod
  â†“ writes data to
Persistent Volume (or ephemeral storage)
  â†“ stored on
EBS Volume on EC2 Node
  â†“ encrypted with
KMS Key (27f15014-7a98-4413-9f8d-2f6686ce0f33)
```

**Verification:**
```bash
# All EBS volumes are encrypted (we just verified this)
aws ec2 describe-volumes --region us-west-2 \
  --filters "Name=tag:kubernetes.io/cluster/incidentfox-demo,Values=owned" \
  --query 'Volumes[*].[VolumeId,Encrypted]'

# Result: All show "True"
```

**This means:** PostgreSQL data files on disk are encrypted at rest! âœ…

---

### 2. âš ï¸ Connection Encryption (SSL/TLS) - Can Enable

**What:** Encrypt data in transit between clients and PostgreSQL

**Status:** â³ **NOT ENABLED** (but easy to add)

**Why it matters:**
- Protects credentials and data during transmission
- Required for SOC2 Type II
- Best practice for production

### How to Enable PostgreSQL SSL

#### Option A: Via Helm Values (Recommended)

Create `incidentfox/helm/values-postgresql-ssl.yaml`:

```yaml
# PostgreSQL SSL Configuration
postgresql:
  # Enable SSL/TLS
  tls:
    enabled: true
    autoGenerated: true  # Auto-generate self-signed cert
    # OR provide your own:
    # certificatesSecret: "postgres-tls-cert"
  
  # Force SSL connections
  primary:
    extraEnvVars:
      - name: POSTGRESQL_ENABLE_TLS
        value: "yes"
      - name: POSTGRESQL_TLS_PREFER_SERVER_CIPHERS
        value: "yes"
    
    # Mount TLS certificates
    extraVolumes:
      - name: tls-certs
        secret:
          secretName: postgresql-tls
    
    extraVolumeMounts:
      - name: tls-certs
        mountPath: /opt/bitnami/postgresql/certs
        readOnly: true
    
    # PostgreSQL config to require SSL
    postgresql:
      conf: |
        ssl = on
        ssl_cert_file = '/opt/bitnami/postgresql/certs/tls.crt'
        ssl_key_file = '/opt/bitnami/postgresql/certs/tls.key'
        ssl_ca_file = '/opt/bitnami/postgresql/certs/ca.crt'
```

**Deploy:**
```bash
helm upgrade otel-demo open-telemetry/opentelemetry-demo \
  -n otel-demo \
  -f incidentfox/helm/values-aws-simple.yaml \
  -f incidentfox/helm/values-postgresql-ssl.yaml
```

#### Option B: Via ConfigMap (Quick Method)

```bash
# Create SSL cert
openssl req -new -x509 -days 365 -nodes -text \
  -out /tmp/server.crt \
  -keyout /tmp/server.key \
  -subj "/CN=postgresql.otel-demo.svc.cluster.local"

# Create Kubernetes secret
kubectl create secret generic postgresql-tls -n otel-demo \
  --from-file=tls.crt=/tmp/server.crt \
  --from-file=tls.key=/tmp/server.key

# Update PostgreSQL deployment to use SSL
kubectl set env deployment/postgresql -n otel-demo \
  POSTGRESQL_ENABLE_TLS=yes

# Restart PostgreSQL
kubectl rollout restart deployment/postgresql -n otel-demo
```

#### Option C: Modify Docker Compose (Local Testing)

Edit `docker-compose.yml`:

```yaml
postgresql:
  image: ${IMAGE_NAME}:${DEMO_VERSION}-postgresql
  environment:
    - POSTGRES_PASSWORD
    - POSTGRES_DB
    - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256  # Strong auth
  command: |
    postgres
      -c ssl=on
      -c ssl_cert_file=/var/lib/postgresql/server.crt
      -c ssl_key_file=/var/lib/postgresql/server.key
  volumes:
    - ./certs/server.crt:/var/lib/postgresql/server.crt:ro
    - ./certs/server.key:/var/lib/postgresql/server.key:ro
```

---

### 3. ğŸ”’ Application-Level Encryption (Most Secure)

**What:** Encrypt data **before** storing in PostgreSQL

**Status:** â³ **NOT IMPLEMENTED** (requires code changes)

**How it works:**

```python
# In accounting service (before storing to DB)
from cryptography.fernet import Fernet

# Encrypt sensitive data
cipher = Fernet(encryption_key)
encrypted_amount = cipher.encrypt(str(transaction_amount).encode())

# Store encrypted value
db.execute(
    "INSERT INTO transactions (amount_encrypted) VALUES (%s)",
    (encrypted_amount,)
)

# When reading, decrypt
encrypted_value = db.fetchone()[0]
amount = cipher.decrypt(encrypted_value).decode()
```

**Use when:** Extra sensitive data (PII, financial)

---

## Current Encryption Status

| Layer | What It Protects | Status | Implementation |
|-------|------------------|--------|----------------|
| **Storage (EBS)** | Data at rest on disk | âœ… Enabled | KMS encryption (done) |
| **Connection (SSL)** | Data in transit | âŒ Not enabled | Enable PostgreSQL SSL |
| **Application** | Data in database | âŒ Not enabled | Code changes needed |

---

## Quick Answer: Is PostgreSQL Data Encrypted?

### âœ… YES - Storage Level

Your PostgreSQL data **IS encrypted at rest** because:
1. PostgreSQL writes data to disk
2. Disk is on EBS volume
3. EBS volume is KMS-encrypted (we just enabled this)

**Even if someone steals the physical disk, they can't read the data!**

### âŒ NO - Connection Level

Connections to PostgreSQL are **NOT encrypted** (plaintext over network)

**Risk:** Someone sniffing network traffic could see queries/data

**SOC2 Impact:**
- **Type I (design):** âœ… OK if documented
- **Type II (operation):** âš ï¸ Should enable SSL for compliance

---

## Recommendation: Enable SSL for Full Compliance

### Quick Win: Enable SSL on PostgreSQL

```bash
cd /Users/apple/Desktop/aws-playground/incidentfox/helm

# Create SSL values file
cat > values-postgresql-ssl.yaml << 'EOF'
# PostgreSQL with SSL enabled

# Note: This assumes using Bitnami PostgreSQL chart
# May need to adjust for the actual chart structure

postgresql:
  auth:
    existingSecret: postgres-credentials
  
  tls:
    enabled: true
    autoGenerated: true  # Auto-generate self-signed cert
  
  primary:
    extraEnvVars:
      - name: POSTGRESQL_ENABLE_TLS
        value: "yes"
EOF

# Upgrade deployment
helm upgrade otel-demo open-telemetry/opentelemetry-demo \
  -n otel-demo \
  -f values-aws-simple.yaml \
  -f values-incidentfox.yaml \
  -f values-postgresql-ssl.yaml
```

---

## Verify Encryption

### Check Storage Encryption:
```bash
# Find PostgreSQL pod's node
POD_NODE=$(kubectl get pod -n otel-demo -l app.kubernetes.io/component=postgresql \
  -o jsonpath='{.items[0].spec.nodeName}')

# Find volumes on that node
aws ec2 describe-instances --region us-west-2 \
  --filters "Name=private-dns-name,Values=${POD_NODE}*" \
  --query 'Reservations[*].Instances[*].BlockDeviceMappings[*].[DeviceName,Ebs.VolumeId]'

# Check if those volumes are encrypted
aws ec2 describe-volumes --region us-west-2 \
  --volume-ids <volume-id> \
  --query 'Volumes[*].[VolumeId,Encrypted,KmsKeyId]'
```

### Check SSL Encryption (After Enabling):
```bash
# Connect and check SSL status
kubectl exec -n otel-demo deployment/postgresql -- \
  psql -U otelu -d otel_demo -c "SHOW ssl;"

# Expected output:
# ssl | on
```

### Check Connection is Using SSL:
```bash
# From accounting pod
kubectl exec -n otel-demo deployment/accounting -- \
  psql "host=postgresql user=otelu dbname=otel_demo sslmode=require" \
  -c "SELECT ssl_is_used();"

# Expected: true
```

---

## SOC2 Compliance Levels

### Current State (Storage Encrypted Only):

âœ… **SOC2 Type I** - Design controls exist
- Data at rest is encrypted
- Documented architecture

âš ï¸ **SOC2 Type II** - Might need SSL
- Depends on auditor requirements
- Best practice: enable SSL

### With SSL Enabled:

âœ… **SOC2 Type I** - Full compliance
âœ… **SOC2 Type II** - Full compliance
- Data at rest: encrypted (EBS + KMS)
- Data in transit: encrypted (SSL/TLS)
- Defense in depth

---

## Implementation Plan

### Phase 1: Verify Current Encryption âœ…

```bash
# You already have this!
aws ec2 describe-volumes --region us-west-2 \
  --filters "Name=tag:kubernetes.io/cluster/incidentfox-demo,Values=owned" \
  --query 'Volumes[*].Encrypted'

# All True = PostgreSQL data on disk is encrypted
```

### Phase 2: Enable PostgreSQL SSL (15 minutes)

```bash
# 1. Create SSL certificate
kubectl create secret generic postgresql-tls -n otel-demo \
  --from-literal=tls.crt="$(openssl req -new -x509 -days 365 -nodes -text -subj '/CN=postgresql' -keyout /dev/stdout 2>/dev/null)" \
  --from-literal=tls.key="$(openssl req -new -x509 -days 365 -nodes -text -subj '/CN=postgresql' -keyout /dev/stdout 2>/dev/null | openssl rsa 2>/dev/null)"

# 2. Update PostgreSQL config
kubectl set env deployment/postgresql -n otel-demo POSTGRESQL_ENABLE_TLS=yes

# 3. Verify
kubectl exec deployment/postgresql -n otel-demo -- psql -U otelu -d otel_demo -c "SHOW ssl;"
```

### Phase 3: Update Client Connections

Update services to use SSL:

```bash
# Update connection string in accounting service
# From: host=postgresql user=otelu password=otelp
# To:   host=postgresql user=otelu password=otelp sslmode=require

kubectl set env deployment/accounting -n otel-demo \
  DB_CONNECTION_STRING="host=postgresql user=otelu password=otelp dbname=otel_demo sslmode=require"

kubectl set env deployment/product-reviews -n otel-demo \
  DB_CONNECTION_STRING="host=postgresql user=otelu password=otelp dbname=otel_demo sslmode=require"
```

---

## What's Actually Running

**PostgreSQL Architecture:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kubernetes Pod (postgresql)             â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Container: PostgreSQL               â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ Data files: /var/lib/postgresql/    â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ Writes to â†“                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“ (if using PVC)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Persistent Volume Claim (PVC)          â”‚
â”‚   â†“ backed by                          â”‚
â”‚ EBS Volume (50GB gp3)                  â”‚
â”‚   ğŸ”’ ENCRYPTED with KMS âœ…             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Or** (if no PVC - ephemeral):
```
PostgreSQL Container
  â†“ writes to
Node's Root Volume
  â†“ which is
EBS Volume on EC2 Instance
  ğŸ”’ ENCRYPTED with KMS âœ…
```

**Either way, data is encrypted on disk!**

---

## Quick Check: Is Your PostgreSQL Data Encrypted?

```bash
# 1. Find which node PostgreSQL is on
kubectl get pod -n otel-demo -l app.kubernetes.io/component=postgresql \
  -o jsonpath='{.items[0].spec.nodeName}'

# Output: ip-10-0-XX-XX.us-west-2.compute.internal

# 2. Get that node's volumes
kubectl get node <node-name> -o yaml | grep "volumeID"

# 3. Check if volume is encrypted
aws ec2 describe-volumes --region us-west-2 --volume-ids vol-XXXXX \
  --query 'Volumes[*].[VolumeId,Encrypted,KmsKeyId]'

# Result: Encrypted = True âœ…
```

---

## Simple Answer

**Q: Is PostgreSQL data encrypted on EC2?**

**A: Yes! âœ…** 

PostgreSQL runs in a Kubernetes pod on your EKS nodes (EC2 instances). The data is stored on EBS volumes, which are **KMS-encrypted** (we just configured this for SOC2).

**Q: Should we enable SSL too?**

**A: Yes, for defense in depth:**
- Storage encryption: âœ… Already have
- Connection encryption: â³ Should add (15 min task)
- Both together: ğŸ”’ Maximum security

---

## Enable SSL Now (Optional but Recommended)

### Quick Command (5 minutes):

```bash
# 1. Generate certificate
openssl req -new -x509 -days 365 -nodes \
  -out /tmp/server.crt \
  -keyout /tmp/server.key \
  -subj "/CN=postgresql.otel-demo.svc.cluster.local"

# 2. Create secret
kubectl create secret tls postgresql-tls -n otel-demo \
  --cert=/tmp/server.crt \
  --key=/tmp/server.key

# 3. Update PostgreSQL pod to use SSL
# (This requires modifying the deployment or helm values)
```

---

## SOC2 Perspective

### What Auditors Care About:

**1. Data at Rest Encryption:**
- âœ… **YOU HAVE THIS** - EBS volumes encrypted with KMS
- Evidence: AWS EC2 console, `aws ec2 describe-volumes`

**2. Data in Transit Encryption:**
- â³ **RECOMMENDED** - PostgreSQL SSL/TLS
- Evidence: PostgreSQL config, `SHOW ssl;` output

### Compliance Matrix:

| Encryption Type | Required for SOC2 | Your Status | Action |
|-----------------|-------------------|-------------|--------|
| Storage (EBS) | âœ… Yes | âœ… Enabled | None - compliant |
| Connections (SSL) | âš ï¸ Depends | âŒ Not enabled | Enable for full compliance |
| Application-level | âŒ No | âŒ Not enabled | Optional (extra security) |

---

## Recommendation

### For SOC2 Audit Tomorrow:

**You're good!** âœ… Storage encryption is the primary requirement and you have it.

### For Production / Type II:

**Enable SSL** (30-minute task) to show defense in depth:

```bash
# Quick SSL enablement script
cd /Users/apple/Desktop/aws-playground/incidentfox

cat > scripts/enable-postgres-ssl.sh << 'EOF'
#!/bin/bash
set -e

echo "Generating SSL certificate..."
openssl req -new -x509 -days 365 -nodes \
  -out /tmp/server.crt \
  -keyout /tmp/server.key \
  -subj "/CN=postgresql"

echo "Creating Kubernetes secret..."
kubectl create secret tls postgresql-tls -n otel-demo \
  --cert=/tmp/server.crt \
  --key=/tmp/server.key \
  --dry-run=client -o yaml | kubectl apply -f -

echo "âœ… SSL certificate ready"
echo "Next: Update PostgreSQL deployment to use it"
echo "See: incidentfox/docs/POSTGRESQL-ENCRYPTION.md"
EOF

chmod +x scripts/enable-postgres-ssl.sh
./scripts/enable-postgres-ssl.sh
```

---

## Summary

**Your PostgreSQL IS encrypted** at the storage level (EBS + KMS). This satisfies SOC2 Type I requirements.

**To go further:**
- Enable SSL/TLS for connection encryption
- Shows defense in depth
- Takes ~15-30 minutes
- No code changes needed (just config)

**Current Status: âœ… Compliant for storage encryption!** ğŸ”’
